<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forest Typing Academy - Carpe Tree'em</title>
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  
  <style>
    /* Typing Game Specific Styles */
    .typing-container {
      max-width: 1000px;
      margin: 200px auto 40px;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(44, 95, 45, 0.1);
    }

    .login-section {
      text-align: center;
      padding: 40px 20px;
    }

    .login-form {
      max-width: 400px;
      margin: 0 auto;
      background: var(--background-color);
      padding: 30px;
      border-radius: 8px;
      border: 2px solid var(--deep-forest-green);
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: var(--deep-forest-green);
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--soft-bark-gray);
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--deep-forest-green);
    }

    .typing-game {
      display: none;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--background-color);
      border-radius: 8px;
      border: 2px solid var(--deep-forest-green);
    }

    .stats {
      display: flex;
      gap: 30px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--deep-forest-green);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-color);
      text-transform: uppercase;
    }

    .lesson-area {
      background: var(--background-color);
      padding: 30px;
      border-radius: 8px;
      border: 2px solid var(--deep-forest-green);
      margin-bottom: 20px;
    }

    .lesson-text {
      font-size: 28px;
      line-height: 2.0;
      color: var(--text-color);
      margin-bottom: 30px;
      min-height: 120px;
      background: white;
      padding: 30px;
      border-radius: 10px;
      border: 3px solid var(--deep-forest-green);
      font-family: 'Courier New', monospace;
      letter-spacing: 1px;
      word-spacing: 3px;
      text-align: left;
      box-shadow: 0 4px 15px rgba(44, 95, 45, 0.1);
      position: relative;
    }

    .lesson-text .current-char {
      background: var(--muted-golden-amber);
      color: white;
      padding: 2px 4px;
      border-radius: 4px;
      font-weight: bold;
    }

    .lesson-text .typed-correct {
      color: var(--deep-forest-green);
      font-weight: bold;
    }

    .lesson-text .typed-incorrect {
      color: #ff4444;
      background: #ffe6e6;
      text-decoration: underline;
    }

    .typing-input {
      width: 100%;
      padding: 20px;
      font-size: 24px;
      border: 3px solid var(--soft-bark-gray);
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      box-sizing: border-box;
      line-height: 1.5;
      letter-spacing: 1px;
      word-spacing: 3px;
      background: white;
      color: var(--deep-forest-green);
      font-weight: bold;
    }

    .typing-input:focus {
      outline: none;
      border-color: var(--deep-forest-green);
      box-shadow: 0 0 15px rgba(44, 95, 45, 0.3);
    }

    .controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }

    .achievements-panel {
      background: var(--background-color);
      padding: 20px;
      border-radius: 8px;
      border: 2px solid var(--deep-forest-green);
      margin-top: 20px;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .achievement-card {
      background: white;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid var(--soft-bark-gray);
      text-align: center;
    }

    .achievement-card.earned {
      border-color: var(--muted-golden-amber);
      background: linear-gradient(135deg, #fff, #f0f8ff);
    }

    .achievement-icon {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .achievement-card.earned .achievement-icon {
      color: var(--muted-golden-amber);
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: var(--soft-bark-gray);
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--deep-forest-green), var(--muted-golden-amber));
      transition: width 0.3s ease;
    }

    .lesson-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .lesson-btn {
      padding: 10px 20px;
      background: var(--background-color);
      border: 2px solid var(--deep-forest-green);
      color: var(--deep-forest-green);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .lesson-btn:hover,
    .lesson-btn.active {
      background: var(--deep-forest-green);
      color: var(--background-color);
    }

    .lesson-btn.completed {
      background: var(--muted-golden-amber);
      border-color: var(--muted-golden-amber);
      color: white;
    }

    .lesson-instructions {
      background: var(--background-color);
      padding: 20px;
      border-radius: 8px;
      border: 2px solid var(--deep-forest-green);
      margin-bottom: 20px;
      text-align: center;
      font-size: 18px;
      color: var(--deep-forest-green);
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .typing-container {
        margin: 150px auto 20px;
        padding: 15px;
      }
      
      .game-header {
        flex-direction: column;
        gap: 15px;
      }
      
      .stats {
        gap: 20px;
      }
      
      .controls {
        flex-direction: column;
      }
    }

    .passage-text span.incorrect { color: red; background-color: #ffdddd; }
  </style>
  <style>
    /* Game Unlock Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: modal-appear 0.3s ease-out;
    }
    @keyframes modal-appear {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .modal-icon {
      font-size: 80px;
      margin-bottom: 20px;
    }
    .modal-title {
      font-size: 32px;
      font-weight: bold;
      color: var(--deep-forest-green);
      margin-bottom: 15px;
    }
    .modal-description {
      font-size: 18px;
      margin-bottom: 30px;
      color: var(--text-color);
    }
    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
    }
  </style>
</head>
<body>
  <!-- Contact Header -->
  <div class="contact-header">
    <a href="tel:250-555-0123"><i class="fas fa-phone"></i> 250-555-0123</a>
    <a href="mailto:info@carpetreeem.ca"><i class="fas fa-envelope"></i> info@carpetreeem.ca</a>
    <a href="lets-talk.html"><i class="fas fa-comments"></i> Get a Quote</a>
  </div>

  <!-- Navigation -->
  <nav>
    <div class="nav-container">
      <div class="nav-logo">
        <a href="index.html">
          <img src="images/logo.png" alt="Carpe Tree'em Logo" class="nav-logo-img">
        </a>
      </div>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="services.html">Services</a>
        <a href="root-knowledge.html">Root Knowledge</a>
        <a href="lets-talk.html">Contact</a>
        <a href="type.html">Typing Game</a>
      </div>
    </div>
  </nav>

  <div class="typing-container">
    <!-- Login Section -->
    <div id="loginSection" class="login-section">
      <h1><i class="fas fa-tree"></i> Forest Typing Academy</h1>
      <p>Master typing while exploring the wonders of nature! Earn badges and track your progress.</p>
      
      <div class="login-form">
        <h2>Welcome Back, Forest Friend!</h2>
        <form id="loginForm">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required>
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required>
          </div>
          <button type="submit" class="cta-button">Login</button>
        </form>
        
        <hr style="margin: 20px 0; border: 1px solid var(--soft-bark-gray);">
        
        <h3>New to the Forest?</h3>
        <form id="signupForm">
          <div class="form-group">
            <label for="newUsername">Choose Username</label>
            <input type="text" id="newUsername" name="newUsername" required>
          </div>
          <div class="form-group">
            <label for="newPassword">Choose Password</label>
            <input type="password" id="newPassword" name="newPassword" required>
          </div>
          <button type="submit" class="cta-button">Create Account</button>
        </form>
      </div>
    </div>

    <!-- Typing Game Section -->
    <div id="typingGame" class="typing-game">
      <div class="game-header">
        <div>
          <h2>Welcome, <span id="userDisplayName"></span>! <i class="fas fa-leaf"></i></h2>
          <p>Current Lesson: <span id="currentLessonName">Home Row Basics</span></p>
        </div>
        <div class="stats">
          <div class="stat-item">
            <div class="stat-value" id="wpmDisplay">0</div>
            <div class="stat-label">WPM</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="accuracyDisplay">0%</div>
            <div class="stat-label">Accuracy</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="streakDisplay">0</div>
            <div class="stat-label">Day Streak</div>
          </div>
        </div>
        <button onclick="logout()" class="cta-button">Logout</button>
      </div>

      <div class="lesson-selector">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 15px;">
          <button class="lesson-btn active" data-lesson="lesson-1">1</button>
          <button class="lesson-btn" data-lesson="lesson-2">2</button>
          <button class="lesson-btn" data-lesson="lesson-3">3</button>
          <button class="lesson-btn" data-lesson="lesson-4">4</button>
          <button class="lesson-btn" data-lesson="lesson-5">5</button>
          <button class="lesson-btn" data-lesson="lesson-6">6</button>
          <button class="lesson-btn" data-lesson="lesson-7">7</button>
          <button class="lesson-btn" data-lesson="lesson-8">8</button>
          <button class="lesson-btn" data-lesson="lesson-9">9</button>
          <button class="lesson-btn" data-lesson="lesson-10">10</button>
          <button class="lesson-btn" data-lesson="lesson-11">11</button>
          <button class="lesson-btn" data-lesson="lesson-12">12</button>
          <button class="lesson-btn" data-lesson="lesson-13">13</button>
          <button class="lesson-btn" data-lesson="lesson-14">14</button>
          <button class="lesson-btn" data-lesson="lesson-15">15</button>
          <button class="lesson-btn" data-lesson="lesson-16">16</button>
          <button class="lesson-btn" data-lesson="lesson-17">17</button>
          <button class="lesson-btn" data-lesson="lesson-18">18</button>
          <button class="lesson-btn" data-lesson="lesson-19">19</button>
          <button class="lesson-btn" data-lesson="lesson-20">20</button>
        </div>
      </div>

      <div class="lesson-area">
        <div style="margin-bottom: 15px;">
          <h3 id="currentLessonName" style="color: var(--deep-forest-green); margin: 0 0 5px 0;">Lesson 1: Home Row Foundation</h3>
          <p id="lessonDescription" style="color: var(--text-color); font-style: italic; margin: 0;">Master the home row keys - the foundation of touch typing</p>
        </div>
        
        <div class="lesson-instructions">
          <i class="fas fa-keyboard"></i> Type the text below exactly as shown. Focus on accuracy first, then speed!
        </div>
        
        <div class="lesson-text" id="lessonText">
          Welcome to the Forest Typing Academy! Start with the home row keys: asdf jkl;
        </div>
        <textarea 
          class="typing-input" 
          id="typingInput" 
          placeholder="Start typing here... Type the entire lesson to complete it"
          rows="4"
        ></textarea>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="controls">
          <button onclick="startLesson()" class="cta-button">Start Lesson</button>
          <button onclick="resetLesson()" class="cta-button">Reset</button>
          <button onclick="finishLesson()" class="cta-button" id="finishBtn" style="display: none;">Finish Lesson</button>
          <button onclick="toggleAchievements()" class="cta-button">View Achievements</button>
        </div>
      </div>

      <div id="achievementsPanel" class="achievements-panel" style="display: none;">
        <h3><i class="fas fa-trophy"></i> Your Forest Achievements</h3>
        <div class="achievements-grid" id="achievementsGrid">
          <!-- Achievements will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Game Unlock Modal -->
  <div class="modal-overlay" id="gameUnlockModal">
    <div class="modal-content">
      <div class="modal-icon" id="gameUnlockIcon">ðŸŽ®</div>
      <h2 class="modal-title">New Game Unlocked!</h2>
      <p class="modal-description">You've unlocked the <strong id="gameUnlockName">...</strong> game!</p>
      <div class="modal-buttons">
        <a href="#" class="cta-button" id="playNowBtn">Play Now</a>
        <button class="cta-button" onclick="closeGameUnlockModal()">Keep Learning</button>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2024 Carpe Tree'em. Professional tree care services.</p>
  </footer>

  <script>
    // User data structure
    let currentUser = null;
    let userData = {
      username: '',
      progress: {
        currentLesson: 'lesson-1',
        wpm: 0,
        accuracy: 0,
        streak: 0,
        completedLessons: [],
        weakKeys: {},
        unlockedGames: []
      },
      achievements: [],
      settings: {
        fingerOverlay: true,
        blankKeyboard: false
      }
    };

    // Lesson content - Professional typing progression
    const lessons = {
      'lesson-1': {
        name: 'Lesson 1: Home Row Foundation',
        description: 'Master the home row keys - the foundation of touch typing',
        keys: ['f', 'j'],
        text: 'f j ff jj fj fj f j f j ff jj ff jj f j ff jj fj fj f j f j ff jj ff jj'
      },
      'lesson-2': {
        name: 'Lesson 2: Left Hand Home Row',
        description: 'Learn the left hand home row keys: a, s, d, f',
        keys: ['a', 's', 'd', 'f'],
        text: 'asdf as as df df asdf asdf a s d f a s d f asdf as as df df asdf asdf'
      },
      'lesson-3': {
        name: 'Lesson 3: Right Hand Home Row',
        description: 'Master the right hand home row: j, k, l, ;',
        keys: ['j', 'k', 'l', ';'],
        text: 'jkl; jk jk l; l; jkl; jkl; j k l ; j k l ; jkl; jk jk l; l; jkl; jkl;'
      },
      'lesson-4': {
        name: 'Lesson 4: Complete Home Row',
        description: 'Practice the entire home row with simple words',
        keys: ['a', 's', 'd', 'f', 'j', 'k', 'l', ';'],
        text: 'asdf jkl; sad sad ask ask dad dad asdf jkl; asdf jkl; sad sad ask ask dad dad'
      },
      'lesson-5': {
        name: 'Lesson 5: Top Row - Left Hand',
        description: 'Learn the left hand top row: q, w, e, r',
        keys: ['q', 'w', 'e', 'r'],
        text: 'qwer we we er er qwer qwer q w e r q w e r qwer we we er er qwer qwer'
      },
      'lesson-6': {
        name: 'Lesson 6: Top Row - Right Hand',
        description: 'Master the right hand top row: t, y, u, i',
        keys: ['t', 'y', 'u', 'i'],
        text: 'tyui ty ty ui ui tyui tyui t y u i t y u i tyui ty ty ui ui tyui tyui'
      },
      'lesson-7': {
        name: 'Lesson 7: Complete Top Row',
        description: 'Practice the entire top row with common words',
        keys: ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i'],
        text: 'qwertyui wet wet try try quit quit qwertyui qwertyui wet wet try try quit quit'
      },
      'lesson-8': {
        name: 'Lesson 8: Bottom Row - Left Hand',
        description: 'Learn the left hand bottom row: z, x, c, v',
        keys: ['z', 'x', 'c', 'v'],
        text: 'zxcv xc xc cv cv zxcv zxcv z x c v z x c v zxcv xc xc cv cv zxcv zxcv'
      },
      'lesson-9': {
        name: 'Lesson 9: Bottom Row - Right Hand',
        description: 'Master the right hand bottom row: b, n, m',
        keys: ['b', 'n', 'm'],
        text: 'bnm bn bn nm nm bnm bnm b n m b n m bnm bn bn nm nm bnm bnm'
      },
      'lesson-10': {
        name: 'Lesson 10: Complete Bottom Row',
        description: 'Practice the entire bottom row with useful words',
        keys: ['z', 'x', 'c', 'v', 'b', 'n', 'm'],
        text: 'zxcvbnm box box can can mix mix zxcvbnm zxcvbnm box box can can mix mix'
      },
      'lesson-11': {
        name: 'Lesson 11: Numbers Row',
        description: 'Learn the number keys: 1, 2, 3, 4, 5, 6, 7, 8, 9, 0',
        keys: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
        text: '12345 67890 123 456 789 012 12345 67890 123 456 789 012'
      },
      'lesson-12': {
        name: 'Lesson 12: Common Symbols',
        description: 'Master essential symbols: !, @, #, $, %, ^, &, *, (, )',
        keys: ['!', '@', '#', '$', '%', '^', '&', '*', '(', ')'],
        text: '!@#$% ^&*() !@# $%^ &*() !@# !@#$% ^&*() !@# $%^ &*() !@#'
      },
      'lesson-13': {
        name: 'Lesson 13: Simple Words',
        description: 'Practice typing common 3-4 letter words',
        keys: ['all'],
        text: 'the and for you can get will make the and for you can get will make'
      },
      'lesson-14': {
        name: 'Lesson 14: Forest Vocabulary',
        description: 'Learn typing with nature and tree-related words',
        keys: ['all'],
        text: 'tree bark leaf branch root trunk forest green tree bark leaf branch root trunk forest green'
      },
      'lesson-15': {
        name: 'Lesson 15: Short Sentences',
        description: 'Practice typing complete sentences',
        keys: ['all'],
        text: 'The tree grows tall. Birds nest in branches. Leaves turn green in spring. Roots anchor the tree.'
      },
      'lesson-16': {
        name: 'Lesson 16: Punctuation',
        description: 'Master common punctuation marks',
        keys: [',', '.', '?', '!', ';', ':', '"', "'"],
        text: 'Hello, world. How are you? Great! I am fine. Yes; that is correct. Hello, world. How are you?'
      },
      'lesson-17': {
        name: 'Lesson 17: Capital Letters',
        description: 'Practice typing with capital letters and shift key',
        keys: ['all'],
        text: 'The Tree Company Forest Management Professional Arborist Tree Care Services The Tree Company provides Forest Management.'
      },
      'lesson-18': {
        name: 'Lesson 18: Speed Building',
        description: 'Focus on increasing your typing speed',
        keys: ['all'],
        text: 'Practice makes perfect. Speed comes with accuracy. Keep your eyes on the screen. Use all your fingers. Practice makes perfect.'
      },
      'lesson-19': {
        name: 'Lesson 19: Accuracy Focus',
        description: 'Concentrate on typing without errors',
        keys: ['all'],
        text: 'Accuracy is more important than speed. Slow down to speed up later. Every error slows you down. Perfect practice makes perfect.'
      },
      'lesson-20': {
        name: 'Lesson 20: Final Challenge',
        description: 'Put all your skills together in a comprehensive test',
        keys: ['all'],
        text: 'Congratulations on completing the Forest Typing Academy! You have learned touch typing fundamentals. Your skills will improve with regular practice.'
      }
    };

    // Achievements
    const achievements = [
      { id: 'first-lesson', name: 'Forest Guardian', icon: 'ðŸŒ²', description: 'Complete your first lesson' },
      { id: 'lesson-5', name: 'Home Row Hero', icon: 'ðŸ ', description: 'Complete the first 5 lessons (Home Row mastery)' },
      { id: 'lesson-10', name: 'Top Row Explorer', icon: 'ðŸ”', description: 'Complete lessons 1-10 (Top and Bottom rows)' },
      { id: 'lesson-15', name: 'Word Weaver', icon: 'ðŸ“', description: 'Complete lessons 1-15 (Words and sentences)' },
      { id: 'lesson-20', name: 'Forest Master', icon: 'ðŸ‘‘', description: 'Complete all 20 lessons' },
      { id: 'wpm-20', name: 'Eagle Ace', icon: 'ðŸ¦…', description: 'Reach 20 WPM' },
      { id: 'wpm-40', name: 'Swift Deer', icon: 'ðŸ¦Œ', description: 'Reach 40 WPM' },
      { id: 'wpm-60', name: 'Lightning Lynx', icon: 'ðŸ†', description: 'Reach 60 WPM' },
      { id: 'accuracy-95', name: 'Precision Owl', icon: 'ðŸ¦‰', description: 'Achieve 95% accuracy' },
      { id: 'accuracy-98', name: 'Perfect Panther', icon: 'ðŸ†', description: 'Achieve 98% accuracy' },
      { id: 'streak-7', name: 'Dedicated Beaver', icon: 'ðŸ¦«', description: '7-day practice streak' },
      { id: 'streak-30', name: 'Forest Legend', icon: 'ðŸŒ³', description: '30-day practice streak' }
    ];

    const themedGames = [
      { id: 'eagle-flight', name: 'Eagle Flight', icon: 'ðŸ¦…', url: 'game-eagle-flight.html' },
      { id: 'bear-cub-rescue', name: 'Bear Cub Rescue', icon: 'ðŸ»', url: 'game-bear-cub-rescue.html' },
      { id: 'salmon-swim', name: 'Salmon Swim', icon: 'ðŸŸ', url: 'game-salmon-swim.html' },
      { id: 'forest-fire-watch', name: 'Forest Fire Watch', icon: 'ðŸ”¥', url: 'game-forest-fire-watch.html' },
      { id: 'whale-watch', name: 'Whale Watch', icon: 'ðŸ‹', url: 'game-whale-watch.html' },
      { id: 'ravens-riddle', name: "Raven's Riddle", icon: 'ðŸ¦', url: 'game-ravens-riddle.html' },
      { id: 'mount-baker-climb', name: 'Mount Baker Climb', icon: 'ðŸ”ï¸', url: 'game-mount-baker-climb.html' }
    ];

    // Game state
    let gameState = {
      isActive: false,
      startTime: null,
      currentText: '',
      typedText: '',
      errors: 0,
      totalCharacters: 0
    };

    // Initialize the game
    document.addEventListener('DOMContentLoaded', function() {
      checkLoginStatus();
      setupEventListeners();
      loadAchievements();
    });

    function setupEventListeners() {
      // Login form
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      document.getElementById('signupForm').addEventListener('submit', handleSignup);
      
      // Typing input
      document.getElementById('typingInput').addEventListener('input', handleTyping);
      document.getElementById('typingInput').addEventListener('keydown', handleKeyDown);
      
      // Lesson selector
      document.querySelectorAll('.lesson-btn').forEach(btn => {
        btn.addEventListener('click', () => selectLesson(btn.dataset.lesson));
      });
    }

    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      // Check if user exists in localStorage
      const users = JSON.parse(localStorage.getItem('typingUsers') || '{}');
      
      if (users[username] && users[username].password === password) {
        loginUser(username, users[username]);
      } else {
        alert('Invalid username or password. Please try again or create a new account.');
      }
    }

    function handleSignup(e) {
      e.preventDefault();
      const username = document.getElementById('newUsername').value;
      const password = document.getElementById('newPassword').value;
      
      if (username.length < 3) {
        alert('Username must be at least 3 characters long.');
        return;
      }
      
      if (password.length < 4) {
        alert('Password must be at least 4 characters long.');
        return;
      }
      
      // Check if username already exists
      const users = JSON.parse(localStorage.getItem('typingUsers') || '{}');
      
      if (users[username]) {
        alert('Username already exists. Please choose a different one.');
        return;
      }
      
      // Create new user
      const newUser = {
        username: username,
        password: password,
        progress: {
          currentLesson: 'lesson-1',
          wpm: 0,
          accuracy: 0,
          streak: 0,
          completedLessons: [],
          weakKeys: {},
          unlockedGames: []
        },
        achievements: [],
        settings: {
          fingerOverlay: true,
          blankKeyboard: false
        },
        createdAt: new Date().toISOString()
      };
      
      users[username] = newUser;
      localStorage.setItem('typingUsers', JSON.stringify(users));
      
      loginUser(username, newUser);
    }

    function loginUser(username, userData) {
      currentUser = username;
      userData = userData;
      
      // Update display
      document.getElementById('userDisplayName').textContent = username;
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('typingGame').style.display = 'block';
      
      // Load user progress
      loadUserProgress();
      selectLesson(userData.progress.currentLesson);
      
      // Check for daily streak
      checkDailyStreak();
    }

    function logout() {
      currentUser = null;
      userData = null;
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('typingGame').style.display = 'none';
      
      // Clear forms
      document.getElementById('loginForm').reset();
      document.getElementById('signupForm').reset();
    }

    function checkLoginStatus() {
      // Check if user is already logged in (for session persistence)
      const lastUser = localStorage.getItem('lastLoggedInUser');
      if (lastUser) {
        const users = JSON.parse(localStorage.getItem('typingUsers') || '{}');
        if (users[lastUser]) {
          loginUser(lastUser, users[lastUser]);
        }
      }
    }

    function selectLesson(lessonId) {
      if (!lessons[lessonId]) return;
      
      // Update active button
      document.querySelectorAll('.lesson-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.lesson === lessonId) {
          btn.classList.add('active');
        }
      });
      
      // Update lesson content
      const lesson = lessons[lessonId];
      document.getElementById('currentLessonName').textContent = lesson.name;
      document.getElementById('lessonDescription').textContent = lesson.description;
      
      // Display lesson text with first character highlighted
      const firstChar = lesson.text.charAt(0);
      const restOfText = lesson.text.substring(1);
      document.getElementById('lessonText').innerHTML = `<span class="current-char">${firstChar}</span>${restOfText}`;
      
      // Reset game state
      resetLesson();
      
      // Update user progress
      if (currentUser) {
        userData.progress.currentLesson = lessonId;
        saveUserProgress();
      }
    }

    function startLesson() {
      if (gameState.isActive) return;
      
      gameState.isActive = true;
      gameState.startTime = new Date();
      gameState.typedText = '';
      gameState.errors = 0;
      gameState.totalCharacters = 0;
      
      document.getElementById('typingInput').value = '';
      document.getElementById('typingInput').focus();
      document.getElementById('progressFill').style.width = '0%';
    }

    function resetLesson() {
      gameState.isActive = false;
      gameState.startTime = null;
      gameState.typedText = '';
      gameState.errors = 0;
      gameState.totalCharacters = 0;
      
      document.getElementById('typingInput').value = '';
      document.getElementById('progressFill').style.width = '0%';
      
      // Restore lesson text with first character highlighted
      const lesson = lessons[userData.progress.currentLesson];
      if (lesson) {
        const firstChar = lesson.text.charAt(0);
        const restOfText = lesson.text.substring(1);
        document.getElementById('lessonText').innerHTML = `<span class="current-char">${firstChar}</span>${restOfText}`;
      }
    }

    function handleTyping(e) {
      if (!gameState.isActive) return;
      
      const input = e.target.value;
      const lesson = lessons[userData.progress.currentLesson];
      const currentText = lesson.text;
      
      gameState.typedText = input;
      gameState.totalCharacters = input.length;
      
      // Calculate progress for entire lesson
      const progress = Math.min((input.length / currentText.length) * 100, 100);
      document.getElementById('progressFill').style.width = progress + '%';
      
      // Calculate errors and update visual feedback
      gameState.errors = 0;
      let visualText = '';
      
      for (let i = 0; i < currentText.length; i++) {
        if (i < input.length) {
          // Character has been typed
          if (input[i] === currentText[i]) {
            visualText += `<span class="typed-correct">${currentText[i]}</span>`;
          } else {
            visualText += `<span class="typed-incorrect">${currentText[i]}</span>`;
            gameState.errors++;
          }
        } else if (i === input.length) {
          // Current character to type
          visualText += `<span class="current-char">${currentText[i]}</span>`;
        } else {
          // Future characters
          visualText += currentText[i];
        }
      }
      
      // Update the lesson text with visual feedback
      document.getElementById('lessonText').innerHTML = visualText;
      
      // Check if lesson is complete
      if (input.length >= currentText.length) {
        completeLesson();
      }
    }

    function handleKeyDown(e) {
      if (!gameState.isActive) return;
      
      // Prevent backspace from going beyond start
      if (e.key === 'Backspace' && gameState.typedText.length === 0) {
        e.preventDefault();
      }
    }

    function completeLesson() {
      gameState.isActive = false;
      
      // Calculate WPM and accuracy
      const timeElapsed = (new Date() - gameState.startTime) / 1000 / 60; // minutes
      const wpm = Math.round((gameState.totalCharacters / 5) / timeElapsed);
      const accuracy = Math.round(((gameState.totalCharacters - gameState.errors) / gameState.totalCharacters) * 100);
      
      // Update user progress
      userData.progress.wpm = Math.max(userData.progress.wpm, wpm);
      userData.progress.accuracy = Math.max(userData.progress.accuracy, accuracy);
      
      // Mark lesson as completed
      const currentLesson = userData.progress.currentLesson;
      if (!userData.progress.completedLessons.includes(currentLesson)) {
        userData.progress.completedLessons.push(currentLesson);
      }
      
      // Update display
      document.getElementById('wpmDisplay').textContent = wpm;
      document.getElementById('accuracyDisplay').textContent = accuracy + '%';
      
      // Check for achievements
      checkAchievements(wpm, accuracy);
      
      // Save progress
      saveUserProgress();
      
      // Show completion message and finish button
      setTimeout(() => {
        alert(`Lesson completed!\nWPM: ${wpm}\nAccuracy: ${accuracy}%\nGreat job, forest friend!`);
        document.getElementById('finishBtn').style.display = 'inline-block';
        document.getElementById('typingInput').disabled = true;
      }, 100);
    }

    function checkAchievements(wpm, accuracy) {
      const newAchievements = [];
      let newlyUnlockedGameId = null;
      
      // First lesson achievement
      if (userData.progress.completedLessons.length === 1) {
        newAchievements.push('first-lesson');
      }
      
      // WPM achievements & Game Unlocks
      if (wpm >= 20 && !userData.achievements.includes('wpm-20')) {
        newAchievements.push('wpm-20');
        if (unlockGame('eagle-flight')) newlyUnlockedGameId = 'eagle-flight';
      }
      if (wpm >= 40 && !userData.achievements.includes('wpm-40')) {
        newAchievements.push('wpm-40');
        if (unlockGame('forest-fire-watch')) newlyUnlockedGameId = 'forest-fire-watch';
      }
      
      // Accuracy achievements & Game Unlocks
      if (accuracy >= 95 && !userData.achievements.includes('accuracy-95')) {
        newAchievements.push('accuracy-95');
        if (unlockGame('whale-watch')) newlyUnlockedGameId = 'whale-watch';
      }

      // Lesson progression achievements & Game Unlocks
      if (userData.progress.completedLessons.length >= 5 && !userData.achievements.includes('lesson-5')) {
        newAchievements.push('lesson-5');
        if (unlockGame('bear-cub-rescue')) newlyUnlockedGameId = 'bear-cub-rescue';
      }
      if (userData.progress.completedLessons.length >= 10 && !userData.achievements.includes('lesson-10')) {
        newAchievements.push('lesson-10');
        if (unlockGame('salmon-swim')) newlyUnlockedGameId = 'salmon-swim';
      }
      if (userData.progress.completedLessons.length >= 15 && !userData.achievements.includes('lesson-15')) {
        newAchievements.push('lesson-15');
        if (unlockGame('ravens-riddle')) newlyUnlockedGameId = 'ravens-riddle';
      }
      if (userData.progress.completedLessons.length >= 20 && !userData.achievements.includes('lesson-20')) {
        newAchievements.push('lesson-20');
        if (unlockGame('mount-baker-climb')) newlyUnlockedGameId = 'mount-baker-climb';
      }
      
      // Add new achievements
      newAchievements.forEach(achievementId => {
        if (!userData.achievements.includes(achievementId)) {
          userData.achievements.push(achievementId);
        }
      });
      
      // Show achievement notifications
      newAchievements.forEach(achievementId => {
        const achievement = achievements.find(a => a.id === achievementId);
        if (achievement) {
          setTimeout(() => {
            alert(`ðŸ† Achievement Unlocked: ${achievement.name}!\n${achievement.description}`);
          }, 200);
        }
      });

      // Show game unlock modal if a game was unlocked
      if (newlyUnlockedGameId) {
        const game = themedGames.find(g => g.id === newlyUnlockedGameId);
        if (game) {
            setTimeout(() => showGameUnlockModal(game), 500);
        }
      }
    }

    function unlockGame(gameId) {
      if (!userData.progress.unlockedGames.includes(gameId)) {
        userData.progress.unlockedGames.push(gameId);
        return true;
      }
      return false;
    }

    function showGameUnlockModal(game) {
        document.getElementById('gameUnlockIcon').innerText = game.icon;
        document.getElementById('gameUnlockName').innerText = game.name;
        document.getElementById('playNowBtn').href = game.url;
        document.getElementById('gameUnlockModal').style.display = 'flex';
    }

    function closeGameUnlockModal() {
        document.getElementById('gameUnlockModal').style.display = 'none';
    }

    function checkDailyStreak() {
      const today = new Date().toDateString();
      const lastLogin = localStorage.getItem(`lastLogin_${currentUser}`);
      
      if (lastLogin !== today) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toDateString();
        
        if (lastLogin === yesterdayStr) {
          userData.progress.streak++;
        } else {
          userData.progress.streak = 1;
        }
        
        localStorage.setItem(`lastLogin_${currentUser}`, today);
        document.getElementById('streakDisplay').textContent = userData.progress.streak;
        
        // Check for streak achievement
        if (userData.progress.streak >= 7 && !userData.achievements.includes('streak-7')) {
          userData.achievements.push('streak-7');
          setTimeout(() => {
            alert('ðŸ† Achievement Unlocked: Dedicated Beaver!\n7-day practice streak achieved!');
          }, 100);
        }
      }
    }

    function loadUserProgress() {
      const users = JSON.parse(localStorage.getItem('typingUsers') || '{}');
      if (users[currentUser]) {
        userData = users[currentUser];
        
        // Update display
        document.getElementById('wpmDisplay').textContent = userData.progress.wpm;
        document.getElementById('accuracyDisplay').textContent = userData.progress.accuracy + '%';
        document.getElementById('streakDisplay').textContent = userData.progress.streak;
        
        // Update lesson buttons
        document.querySelectorAll('.lesson-btn').forEach(btn => {
          const lessonId = btn.dataset.lesson;
          if (userData.progress.completedLessons.includes(lessonId)) {
            btn.classList.add('completed');
          }
        });
      }
    }

    function saveUserProgress() {
      const users = JSON.parse(localStorage.getItem('typingUsers') || '{}');
      users[currentUser] = userData;
      localStorage.setItem('typingUsers', JSON.stringify(users));
      localStorage.setItem('lastLoggedInUser', currentUser);
    }

    function loadAchievements() {
      const grid = document.getElementById('achievementsGrid');
      grid.innerHTML = '';
      
      achievements.forEach(achievement => {
        const card = document.createElement('div');
        card.className = 'achievement-card';
        if (userData && userData.achievements.includes(achievement.id)) {
          card.classList.add('earned');
        }
        
        card.innerHTML = `
          <div class="achievement-icon">${achievement.icon}</div>
          <h4>${achievement.name}</h4>
          <p>${achievement.description}</p>
        `;
        
        grid.appendChild(card);
      });
    }

    function toggleAchievements() {
      const panel = document.getElementById('achievementsPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function finishLesson() {
      // Hide the lesson area
      document.querySelector('.lesson-area').style.display = 'none';
      
      // Show completion message
      const lessonName = document.getElementById('currentLessonName').textContent;
      alert(`Congratulations! You've completed ${lessonName}!`);
      
      // Reset for next lesson
      document.getElementById('finishBtn').style.display = 'none';
      document.getElementById('typingInput').disabled = false;
      resetLesson();
    }
  </script>
</body>
</html> 