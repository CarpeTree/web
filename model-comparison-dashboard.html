<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Model Comparison Dashboard | Carpe Tree'em</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .model-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid;
        }

        .model-card.o4-mini { border-left-color: #4CAF50; }
        .model-card.o3 { border-left-color: #2196F3; }
        .model-card.gemini { border-left-color: #FF9800; }

        .model-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .model-name {
            font-size: 1.4em;
            font-weight: bold;
        }

        .model-badge {
            padding: 5px 10px;
            border-radius: 20px;
            color: white;
            font-size: 0.9em;
            font-weight: bold;
        }

        .badge-fast { background: #4CAF50; }
        .badge-premium { background: #2196F3; }
        .badge-multimodal { background: #FF9800; }

        .model-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .analysis-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
        }

        .comparison-toolbar {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .refresh-btn:hover {
            background: #0056b3;
        }

        .quote-info {
            color: #666;
        }

        @media (max-width: 768px) {
            .model-grid {
                grid-template-columns: 1fr;
            }
            
            .model-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Model Comparison Dashboard</h1>
            <p>Compare OpenAI o4-mini-2025-04-16, o3-pro-2025-06-10, and Gemini 2.5 Pro analysis results side-by-side</p>
        </div>

        <div class="comparison-toolbar">
            <div class="quote-info">
                <span id="quote-info">Loading quote information...</span>
            </div>
            <button class="refresh-btn" onclick="refreshAnalysis()">üîÑ Refresh All</button>
        </div>

        <div class="model-grid">
            <!-- o4-mini Card -->
            <div class="model-card o4-mini">
                <div class="model-header">
                    <div class="model-name">o4-mini-2025-04-16</div>
                    <div class="model-badge badge-fast">FAST & EFFICIENT</div>
                </div>
                <div class="model-stats">
                    <div class="stat">
                        <div class="stat-value" id="o4-cost">$0.00</div>
                        <div class="stat-label">Cost</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="o4-status">‚è≥</div>
                        <div class="stat-label">Status</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="o4-tokens">0</div>
                        <div class="stat-label">Tokens</div>
                    </div>
                </div>
                <div class="analysis-content" id="o4-analysis">
                    <div class="loading">Loading o4-mini-2025-04-16 analysis...</div>
                </div>
            </div>

            <!-- o3 Card -->
            <div class="model-card o3">
                <div class="model-header">
                    <div class="model-name">o3</div>
                    <div class="model-badge badge-premium">PREMIUM REASONING</div>
                </div>
                <div class="model-stats">
                    <div class="stat">
                        <div class="stat-value" id="o3-cost">$0.00</div>
                        <div class="stat-label">Cost</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="o3-status">‚è≥</div>
                        <div class="stat-label">Status</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="o3-tokens">0</div>
                        <div class="stat-label">Tokens</div>
                    </div>
                </div>
                <div class="analysis-content" id="o3-analysis">
                    <div class="loading">Loading o3-pro-2025-06-10 analysis...</div>
                </div>
            </div>

            <!-- Gemini 2.5 Pro Card -->
            <div class="model-card gemini">
                <div class="model-header">
                    <div class="model-name">Gemini 2.5 Pro</div>
                    <div class="model-badge badge-multimodal">MULTIMODAL</div>
                </div>
                <div class="model-stats">
                    <div class="stat">
                        <div class="stat-value" id="gemini-cost">$0.00</div>
                        <div class="stat-label">Cost</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="gemini-status">‚è≥</div>
                        <div class="stat-label">Status</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="gemini-media">0</div>
                        <div class="stat-label">Media Files</div>
                    </div>
                </div>
                <div class="analysis-content" id="gemini-analysis">
                    <div class="loading">Loading Gemini 2.5 Pro analysis...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const quoteId = urlParams.get('quote_id');
        
        if (!quoteId) {
            alert('Quote ID required. Use: ?quote_id=123');
        }

        async function loadQuoteInfo() {
            try {
                const response = await fetch(`/server/api/admin-quotes.php?quote_id=${quoteId}`);
                const data = await response.json();
                
                const quote = data.quotes?.find(q => q.id == quoteId);
                if (quote) {
                    document.getElementById('quote-info').innerHTML = 
                        `Quote #${quoteId} - ${quote.customer_name} (${quote.customer_email})`;
                }
            } catch (error) {
                console.error('Failed to load quote info:', error);
            }
        }

        async function loadModelAnalysis(model, elementPrefix) {
            try {
                const response = await fetch(`/server/api/admin-quotes.php?quote_id=${quoteId}`);
                const data = await response.json();
                
                const quote = data.quotes?.find(q => q.id == quoteId);
                if (!quote) return;

                let analysis_data = null;
                let fieldName = '';
                
                switch(model) {
                    case 'o4-mini':
                        fieldName = 'ai_o4_mini_analysis';
                        break;
                    case 'o3':
                        fieldName = 'ai_o3_analysis';
                        break;
                    case 'gemini':
                        fieldName = 'ai_gemini_analysis';
                        break;
                }

                if (quote[fieldName] && typeof quote[fieldName] === 'string') {
                    try {
                        analysis_data = JSON.parse(quote[fieldName]);
                    } catch (e) {
                        console.error('Failed to parse analysis JSON for model:', model, e);
                        analysis_data = { analysis: 'Error: Invalid JSON format.' };
                    }
                }

                if (analysis_data) {
                    // Update stats
                    document.getElementById(`${elementPrefix}-cost`).textContent = 
                        `$${(analysis_data.cost || 0).toFixed(4)}`;
                    document.getElementById(`${elementPrefix}-status`).textContent = '‚úÖ';
                    
                    if (analysis_data.input_tokens && analysis_data.output_tokens) {
                        const totalTokens = analysis_data.input_tokens + analysis_data.output_tokens;
                        document.getElementById(`${elementPrefix}-tokens`).textContent = totalTokens.toLocaleString();
                    } else if (analysis_data.media_count) {
                        document.getElementById(`${elementPrefix}-media`).textContent = 
                            analysis_data.media_count;
                    }
                    
                    // Update analysis content
                    // The actual analysis is nested inside another 'analysis' object
                    const analysisContent = analysis_data.analysis ? JSON.stringify(analysis_data.analysis, null, 2) : 'Analysis completed but content not available';
                    document.getElementById(`${elementPrefix}-analysis`).textContent = analysisContent;
                } else {
                    document.getElementById(`${elementPrefix}-analysis`).innerHTML = 
                        '<div class="error">No analysis data available for this model</div>';
                    document.getElementById(`${elementPrefix}-status`).textContent = '‚ùå';
                }
                
            } catch (error) {
                console.error(`Failed to load ${model} analysis:`, error);
                document.getElementById(`${elementPrefix}-analysis`).innerHTML = 
                    '<div class="error">Failed to load analysis data</div>';
                document.getElementById(`${elementPrefix}-status`).textContent = '‚ùå';
            }
        }

        async function refreshAnalysis() {
            // Reset UI and show loading indicators
            ['o4', 'o3', 'gemini'].forEach(prefix => {
                document.getElementById(`${prefix}-analysis`).innerHTML = 
                    '<div class="loading">Triggering new analysis...</div>';
                document.getElementById(`${prefix}-status`).textContent = '‚è≥';
            });
            
            try {
                // Trigger all three models to run in the background
                const response = await fetch(`/server/api/trigger-all-analyses.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `quote_id=${quoteId}`
                });
                const result = await response.json();
                
                if (result.success) {
                    // Start polling for results
                    pollForResults();
                } else {
                    throw new Error(result.error || 'Failed to trigger analyses');
                }
            } catch (error) {
                console.error('Failed to trigger analyses:', error);
                alert('Error: ' + error.message);
            }
        }

        let pollInterval;
        function pollForResults() {
            // Clear any existing polling
            if (pollInterval) clearInterval(pollInterval);
            
            // Poll every 5 seconds
            pollInterval = setInterval(async () => {
                const isComplete = await loadAllAnalyses();
                if (isComplete) {
                    clearInterval(pollInterval);
                }
            }, 5000);
        }

        async function loadAllAnalyses() {
            await Promise.all([
                loadModelAnalysis('o4-mini', 'o4'),
                loadModelAnalysis('o3', 'o3'),
                loadModelAnalysis('gemini', 'gemini')
            ]);
            
            // Check if all are complete
            const statuses = [
                document.getElementById('o4-status').textContent,
                document.getElementById('o3-status').textContent,
                document.getElementById('gemini-status').textContent
            ];
            return statuses.every(s => s === '‚úÖ' || s === '‚ùå');
        }

        // Initial load
        loadQuoteInfo();
        refreshAnalysis();

        // Auto-refresh every 30 seconds
        setInterval(refreshAnalysis, 30000);
    </script>
</body>
</html>