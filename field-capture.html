<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Quick Capture - Carpe Tree'em</title>
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="stylesheet" href="https://releases.transloadit.com/uppy/v3.24.0/uppy.min.css" />
  <style>
    /* LIQUID GLASS THEME - Field Capture */
    :root {
      --green: #2D5A27;
      --amber: #D4A373;
      --bg: #f5f7fa;
      --text: #222;
      --glass-bg: rgba(255, 255, 255, 0.18);
      --glass-border: rgba(255, 255, 255, 0.28);
      --glass-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
      --glass-hover: rgba(255, 255, 255, 0.25);
    }
    
    .dark {
      --bg: #1a1a1a;
      --text: #f5f5f5;
      --glass-bg: rgba(15, 23, 42, 0.25);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      --glass-hover: rgba(255, 255, 255, 0.15);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      background: linear-gradient(135deg, var(--bg) 0%, rgba(44, 95, 45, 0.08) 50%, var(--bg) 100%);
      color: var(--text);
      min-height: 100vh;
      transition: all 0.3s ease;
    }
    
    .dark body {
      background: linear-gradient(135deg, #1a1a1a 0%, rgba(44, 95, 45, 0.15) 50%, #1a1a1a 100%);
    }
    
    .wrap { 
      max-width: 720px; 
      margin: 0 auto; 
      padding: 16px; 
    }
    
    /* LIQUID GLASS HEADER */
    .header { 
      position: sticky; 
      top: 0; 
      backdrop-filter: saturate(1.2) blur(12px);
      -webkit-backdrop-filter: saturate(1.2) blur(12px);
      background: rgba(44, 95, 45, 0.92);
      color: #fff; 
      padding: 12px 20px; 
      font-weight: 800; 
      font-size: 1.1rem;
      z-index: 10;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-links {
      display: flex;
      gap: 8px;
    }
    
    /* GLASS PILL HEADER LINKS */
    .header-links a {
      color: white;
      text-decoration: none;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 20px;
      border: 1.5px solid rgba(255, 255, 255, 0.5);
      background: rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    
    .header-links a:hover {
      background: rgba(255, 255, 255, 0.95);
      color: var(--green);
      border-color: white;
    }
    
    /* LIQUID GLASS CARDS */
    .card { 
      backdrop-filter: saturate(1.15) blur(12px);
      -webkit-backdrop-filter: saturate(1.15) blur(12px);
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px; 
      box-shadow: var(--glass-shadow);
      padding: 20px; 
      margin: 16px 0;
      transition: all 0.3s ease;
    }
    
    .card:hover {
      box-shadow: 0 8px 32px rgba(44, 95, 45, 0.2);
      transform: translateY(-2px);
    }
    
    /* LIQUID GLASS BUTTONS */
    .btn { 
      display: inline-block; 
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      background: linear-gradient(135deg, var(--green), rgba(44, 95, 45, 0.85));
      color: #fff; 
      padding: 14px 20px; 
      border: none; 
      border-radius: 12px; 
      font-weight: 700; 
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(44, 95, 45, 0.4);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(44, 95, 45, 0.5);
    }
    
    .btn:disabled { 
      opacity: 0.6; 
      cursor: not-allowed; 
      transform: none;
    }
    
    .hint { 
      font-size: 12px; 
      color: #666; 
      margin-top: 8px;
    }
    
    .dark .hint {
      color: #aaa;
    }
    
    .row { 
      display: flex; 
      gap: 12px; 
      align-items: center;
      flex-wrap: wrap;
    }
    
    .label { 
      font-size: 12px; 
      color: var(--green); 
      font-weight: 800; 
      text-transform: uppercase; 
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .dark .label {
      color: var(--amber);
    }
    
    input, textarea { 
      width: 100%; 
      padding: 12px; 
      border: 1px solid var(--glass-border); 
      border-radius: 12px; 
      font-size: 14px;
      background: var(--glass-bg);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: var(--text);
      transition: all 0.2s ease;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(44, 95, 45, 0.2);
    }
    
    .success { 
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      background: rgba(44, 95, 45, 0.15);
      border: 1px solid rgba(44, 95, 45, 0.3); 
      border-radius: 12px; 
      padding: 16px;
    }
    
    .code { 
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; 
      font-weight: 800; 
      color: var(--green);
      background: rgba(44, 95, 45, 0.1);
      padding: 4px 8px;
      border-radius: 6px;
    }
    
    .inline { 
      color: var(--green); 
      font-weight: 700; 
      text-decoration: none;
    }
    
    .inline:hover {
      text-decoration: underline;
    }
    
    /* Theme Toggle */
    .theme-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--glass-shadow);
      transition: all 0.3s ease;
      z-index: 100;
    }
    
    .theme-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }
    
    /* Uppy Dashboard styling override */
    .uppy-Dashboard {
      border-radius: 12px !important;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div class="header">
    <span>Quick Capture</span>
    <div class="header-links">
      <a href="admin-dashboard.html">Dashboard</a>
      <a href="quote-map-dashboard.html">Maps</a>
      <a href="index.html">Home</a>
    </div>
  </div>
  
  <div class="wrap" x-data="capture()" x-init="init()">
    <div class="card">
      <div class="label">Location</div>
      <div class="row">
        <button class="btn" @click="getLocation()" :disabled="busy">Use My Location</button>
        <div class="hint" x-text="locText"></div>
      </div>
      <div class="hint" style="margin-top:8px;" x-show="address">
        Address (reverse geocoded): <span x-text="address"></span>
      </div>
    </div>

    <div class="card">
      <div class="label">Media Upload</div>
      <div id="uppy" class="uppy"></div>
      <div class="hint">Tip: Add a short video and a few photos. You can also add a voice note below.</div>
    </div>

    <div class="card">
      <div class="label">Voice/Notes</div>
      <textarea rows="3" placeholder="Dictate notes, hazards, access info, services to recommend..." x-model="notes"></textarea>
    </div>

    <div class="card" x-show="!submitted">
      <button class="btn" @click="submit()" :disabled="busy" style="width: 100%;">Save & Generate Code</button>
      <div class="hint" style="margin-top:10px;" x-show="busy">Uploading & triggering AI... don't close this tab.</div>
    </div>

    <div class="card success" x-show="submitted">
      <div style="font-weight:800; margin-bottom:8px; font-size: 1.1rem;">Saved Successfully!</div>
      <div>Leave this code on the door card: <span class="code" x-text="leadCode"></span></div>
      <div style="margin-top:10px;">Customer link: <a class="inline" :href="leadUrl" target="_blank" x-text="leadUrl"></a></div>
      <div class="hint" style="margin-top:10px;">AI analysis is running in the background. You can review in the admin dashboard.</div>
    </div>
  </div>

  <!-- Theme Toggle -->
  <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
    <span id="themeIcon"></span>
  </button>

  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://releases.transloadit.com/uppy/v3.24.0/uppy.min.js"></script>
  <script>
    // Theme Toggle
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = savedTheme === 'dark' || (!savedTheme && prefersDark);
      
      if (isDark) {
        document.documentElement.classList.add('dark');
      }
      
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      
      function updateThemeIcon() {
        themeIcon.textContent = document.documentElement.classList.contains('dark') ? 'â˜€ï¸' : 'ðŸŒ™';
      }
      
      updateThemeIcon();
      
      themeToggle.addEventListener('click', function() {
        const isDarkMode = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        updateThemeIcon();
      });
    })();
    
    function capture() {
      return {
        uppy: null,
        files: [],
        gps: null,
        address: '',
        notes: '',
        busy: false,
        submitted: false,
        leadCode: '',
        leadUrl: '',
        locText: 'Tap to capture GPS',

        init() {
          this.uppy = new Uppy.Uppy({ 
            restrictions: { 
              allowedFileTypes: ['image/*','video/*','audio/*'], 
              maxFileSize: 1024*1024*1024 // 1GB
            } 
          });
          this.uppy.use(Uppy.Dashboard, { 
            target: '#uppy', 
            inline: true, 
            height: 300, 
            showProgressDetails: true 
          });
          this.uppy.on('file-added', (f) => { this.files.push(f); });
          this.uppy.on('file-removed', (f) => { this.files = this.files.filter(x => x.id !== f.id); });
        },

        async getLocation() {
          try {
            const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 15000 }));
            this.gps = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
            this.locText = `GPS ${this.gps.lat.toFixed(5)}, ${this.gps.lng.toFixed(5)} (Â±${Math.round(this.gps.acc)}m)`;
            
            // Try reverse geocoding
            try {
              const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${this.gps.lat}&lon=${this.gps.lng}&zoom=18&addressdetails=1`);
              const data = await response.json();
              if (data.display_name) {
                this.address = data.display_name;
              }
            } catch (e) {
              console.log('Reverse geocode failed:', e);
            }
          } catch (e) { 
            alert('Location error: ' + (e?.message||'unknown')); 
          }
        },

        async submit() {
          if (this.busy) return;
          if (this.files.length === 0) {
            alert('Please add at least one photo or video.');
            return;
          }
          this.busy = true;
          try {
            const fd = new FormData();
            if (this.gps) {
              fd.append('gpsLat', this.gps.lat);
              fd.append('gpsLng', this.gps.lng);
              fd.append('gpsAccuracy', this.gps.acc||'');
            }
            fd.append('notes', this.notes||'');
            fd.append('address', this.address||'');
            
            // Append files
            this.files.forEach((f, i) => fd.append(`files[${i}]`, f.data, f.name||`file_${i}`));

            const res = await fetch('/server/api/field-capture-submit.php', { method: 'POST', body: fd });
            const data = await res.json();
            if (!data?.success) throw new Error(data?.error || 'Submission failed');
            this.submitted = true;
            this.leadCode = data.code;
            this.leadUrl = data.link;
            if (data.address) this.address = data.address;
          } catch (e) {
            alert('Submit failed: ' + (e?.message||'unknown'));
          } finally { this.busy = false; }
        }
      }
    }
  </script>
</body>
</html>
