<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carpe Tree Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a4d3a 50%, #0a0a0a 100%);
            color: #ffffff;
            min-height: 100vh;
            transition: all 0.5s ease;
        }
        body[data-theme="light"] {
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 50%, #e0f2fe 100%);
            color: #1f2937;
        }
        .header {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        body[data-theme="light"] .header {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: #ffffff;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        body[data-theme="light"] .theme-toggle {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.2);
            color: #1f2937;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        body[data-theme="light"] .btn {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #1f2937;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); }
        .btn-primary { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; }
        .btn-gpt5 { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; }
        .btn-gemini { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; }
        .btn-transcribe { background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; border: none; }
        .quote-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }
        body[data-theme="light"] .quote-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #1f2937;
        }
        .quote-card:hover { transform: translateY(-4px); box-shadow: 0 8px 32px rgba(16, 185, 129, 0.15); }
        .ai-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        body[data-theme="light"] .ai-section {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #1f2937;
        }
        .service-item {
            display: flex;
            align-items: start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        body[data-theme="light"] .service-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #1f2937;
        }
        .service-item:hover { 
            background: rgba(16, 185, 129, 0.1); 
            transform: translateX(8px);
            border-left: 3px solid #10b981;
        }
        .service-checkbox { 
            width: 20px; 
            height: 20px; 
            margin-top: 0.25rem; 
            accent-color: #10b981; 
            cursor: pointer;
        }
        .selected-summary {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: rgba(16, 185, 129, 0.9);
            border: 2px solid #10b981;
            border-radius: 16px;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            max-width: 400px;
            color: white;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        }
        body[data-theme="light"] .selected-summary {
            background: rgba(16, 185, 129, 0.95);
            color: white;
        }
        .line-item-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .gpt5-badge { background: #f59e0b; color: white; }
        .gemini-badge { background: #8b5cf6; color: white; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body x-data="dashboard()" x-init="init()">
    <div class="header">
        <h1>üå≤ Carpe Tree Admin Dashboard</h1>
        <button class="theme-toggle" @click="toggleTheme()">
            <span x-show="isDark">‚òÄÔ∏è Light Mode</span>
            <span x-show="!isDark">üåô Dark Mode</span>
        </button>
    </div>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 style="color: #10b981;">Quote Analysis Dashboard</h2>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <div x-show="selectedItems.length > 0" style="color: #10b981; font-weight: 600;">
                    <span x-text="selectedItems.length"></span> items selected
                </div>
                <button class="btn btn-primary" @click="loadQuotes()">üîÑ Refresh</button>
            </div>
        </div>
        <div x-show="loading" style="text-align: center; padding: 3rem;">
            <div style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
            Loading quotes...
        </div>
        <template x-for="quote in quotes" :key="quote.id">
            <div class="quote-card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <h3 x-text="`Quote #${quote.id}`" style="color: #10b981; font-size: 1.4rem;"></h3>
                    <span style="background: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.8rem;" x-text="quote.status || 'pending'"></span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; font-size: 0.9rem;">
                    <div><strong>üë§ Customer:</strong> <span x-text="quote.customer_name || 'Not provided'"></span></div>
                    <div><strong>üìß Email:</strong> <span x-text="quote.customer_email || 'Not provided'"></span></div>
                    <div><strong>üìû Phone:</strong> <span x-text="quote.phone || 'Not provided'"></span></div>
                    <div><strong>üìç Address:</strong> <span x-text="quote.address || 'Not provided'"></span></div>
                    <div><strong>üìÅ Files:</strong> <span x-text="`${quote.files.length} media files`"></span></div>
                    <div x-show="quote.distance_km"><strong>üöó Distance:</strong> <span x-text="`${quote.distance_km} km`"></span></div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <button class="btn btn-transcribe" @click="transcribeMedia(quote)">üé§ Transcribe Audio</button>
                    <button class="btn btn-gpt5" @click="runGPT5Analysis(quote)" :disabled="gptLoading">
                        <span x-show="!gptLoading">üî• Run GPT-5</span>
                        <span x-show="gptLoading">‚è≥ GPT-5...</span>
                    </button>
                    <button class="btn btn-gemini" @click="runGeminiAnalysis(quote)" :disabled="geminiLoading">
                        <span x-show="!geminiLoading">üíé Run Gemini</span>
                        <span x-show="geminiLoading">‚è≥ Gemini...</span>
                    </button>
                    <button class="btn btn-primary" @click="runBothAI(quote)" :disabled="gptLoading || geminiLoading">üöÄ Run Both AI</button>
                    <button class="btn" @click="toggleContext(quote.id)">üìù Context</button>
                    <button class="btn" @click="showRawAI(quote.id)">üîç Raw AI</button>
                </div>

                <!-- Context Editor -->
                <div x-show="quote.showContext" style="margin: 1rem 0; padding: 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px;">
                    <h4 style="margin-bottom: 0.5rem; font-weight: 600;">üìù Additional Context for Quote #<span x-text="quote.id"></span></h4>
                    <textarea x-model="quote.context" style="width: 100%; height: 80px; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: inherit; font-size: 0.875rem; resize: vertical;" placeholder="Add specific context, customer language, hazards, etc."></textarea>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end;">
                        <button @click="clearContext(quote.id)" class="btn">Clear</button>
                        <button @click="saveContext(quote.id)" class="btn btn-primary">üíæ Save</button>
                    </div>
                </div>

                <!-- GPT-5 Line Items with Checkboxes -->
                <div x-show="quote.gpt_analysis && quote.gpt_analysis.services && quote.gpt_analysis.services.length > 0" class="ai-section" style="border-left: 4px solid #f59e0b;">
                    <h4 style="color: #f59e0b; margin-bottom: 1rem; font-size: 1.2rem;">
                        üî• GPT-5 Services - Select for Estimate
                        <span class="line-item-badge gpt5-badge" data-testid="gpt5-services-badge" x-text="`${(quote.gpt_analysis && quote.gpt_analysis.services ? quote.gpt_analysis.services.length : 0)} services`"></span>
                    </h4>
                    <template x-for="(service, index) in (quote.gpt_analysis && quote.gpt_analysis.services ? quote.gpt_analysis.services : [])" :key="`gpt-${quote.id}-${index}`">
                        <label class="service-item" :for="`gpt-checkbox-${quote.id}-${index}`">
                            <input 
                                type="checkbox" 
                                class="service-checkbox"
                                :id="`gpt-checkbox-${quote.id}-${index}`"
                                @change="toggleLineItem('GPT-5', quote.id, index, service, $event.target.checked)"
                            >
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem;" x-text="service.name"></div>
                                <div style="opacity: 0.8; margin-bottom: 0.75rem; line-height: 1.4;" x-text="service.description"></div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="color: #f59e0b; font-weight: 700; font-size: 1.3rem;" x-text="`$${service.cost}`"></div>
                                    <div style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;" x-text="service.priority"></div>
                                </div>
                            </div>
                        </label>
                    </template>
                </div>

                <!-- Gemini Line Items with Checkboxes -->
                <div x-show="quote.gemini_analysis && quote.gemini_analysis.services && quote.gemini_analysis.services.length > 0" class="ai-section" style="border-left: 4px solid #8b5cf6;">
                    <h4 style="color: #8b5cf6; margin-bottom: 1rem; font-size: 1.2rem;">
                        üíé Gemini Services - Select for Estimate
                        <span class="line-item-badge gemini-badge" data-testid="gemini-services-badge" x-text="`${(quote.gemini_analysis && quote.gemini_analysis.services ? quote.gemini_analysis.services.length : 0)} services`"></span>
                    </h4>
                    <template x-for="(service, index) in (quote.gemini_analysis && quote.gemini_analysis.services ? quote.gemini_analysis.services : [])" :key="`gemini-${quote.id}-${index}`">
                        <label class="service-item" :for="`gemini-checkbox-${quote.id}-${index}`">
                            <input 
                                type="checkbox" 
                                class="service-checkbox"
                                :id="`gemini-checkbox-${quote.id}-${index}`"
                                @change="toggleLineItem('Gemini', quote.id, index, service, $event.target.checked)"
                            >
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem;" x-text="service.name"></div>
                                <div style="opacity: 0.8; margin-bottom: 0.75rem; line-height: 1.4;" x-text="service.description"></div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="color: #8b5cf6; font-weight: 700; font-size: 1.3rem;" x-text="`$${service.cost}`"></div>
                                    <div style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;" x-text="service.priority"></div>
                                </div>
                            </div>
                        </label>
                    </template>
                </div>

                <!-- Transcript Display -->
                <div x-show="quote.transcript" class="ai-section" style="border-left: 4px solid #06b6d4;">
                    <h4 style="color: #06b6d4; margin-bottom: 1rem;">üé§ Audio Transcript</h4>
                    <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; font-size: 0.9rem; line-height: 1.6;" x-text="quote.transcript"></div>
                </div>

                <!-- No Analysis Message -->
                <div x-show="!quote.gpt_analysis && !quote.gemini_analysis" style="text-align: center; padding: 3rem; opacity: 0.7; background: rgba(255,255,255,0.05); border-radius: 12px; margin-top: 1rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">ü§ñ</div>
                    <p style="font-size: 1.1rem; margin-bottom: 1rem;">No AI analysis available</p>
                    <p style="opacity: 0.8;">Click "Run GPT-5" or "Run Gemini" above to analyze this quote and see line items.</p>
                </div>
            </div>
        </template>
    </div>

    <!-- Selected Items Estimate Builder -->
    <div x-show="selectedItems.length > 0" class="selected-summary">
        <h3 style="margin-bottom: 1rem; font-size: 1.3rem;">üìã Selected Line Items</h3>
        <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
            <template x-for="item in selectedItems" :key="item.id">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(255,255,255,0.1); border-radius: 8px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;" x-text="item.name"></div>
                        <div style="font-size: 0.8rem; opacity: 0.8;" x-text="item.source + ' Analysis'"></div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-weight: 700; font-size: 1.1rem;" x-text="`$${item.cost}`"></span>
                        <button @click="removeLineItem(item.id)" style="color: #ef4444; background: rgba(239, 68, 68, 0.2); border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 1rem;">√ó</button>
                    </div>
                </div>
            </template>
        </div>
        <div style="border-top: 2px solid rgba(255,255,255,0.2); padding-top: 1rem; margin-top: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span style="font-weight: 700; font-size: 1.2rem;">Total:</span>
                <span style="font-weight: 700; font-size: 1.4rem;" x-text="`$${selectedItems.reduce((sum, item) => sum + parseFloat(item.cost || 0), 0).toFixed(2)}`"></span>
            </div>
            <button class="btn btn-primary" @click="createEstimate()" style="width: 100%; font-size: 1.1rem; padding: 1rem;">
                üìä Create Professional Estimate
            </button>
        </div>
    </div>

    <!-- Raw AI Modal -->
    <div x-show="showRawModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: flex; align-items: center; justify-content: center; z-index: 200;">
        <div style="background: #0b0f0e; color: #e5e7eb; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 12px 28px rgba(0,0,0,0.5); border-radius: 12px; max-width: 1000px; width: 96%; max-height: 85vh; overflow: auto; padding: 1rem;">
            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 0.5rem;">
                <h3>üîç Raw AI Output</h3>
                <button class="btn" @click="showRawModal=false">Close</button>
            </div>
            <div x-show="rawAiImages.length > 0" class="mb-4" style="margin-bottom: 1rem;">
                <h4 style="margin-bottom: 0.5rem;">üñºÔ∏è Analyzed Images/Frames</h4>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem;">
                    <template x-for="(img, idx) in rawAiImages" :key="idx">
                        <div style="text-align:center;">
                            <img :src="img.url" :alt="img.source" style="width:100%; height:100px; object-fit:cover; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 0.75rem; margin-top: 0.25rem;" x-text="img.source"></div>
                        </div>
                    </template>
                </div>
            </div>
            <pre x-text="rawAiContent" style="white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; line-height: 1.5; background: #111827; color: #e5e7eb; border-radius: 6px; padding: 0.75rem;"></pre>
        </div>
    </div>

    <script>
        // Helpers for robust parsing and safe rendering
        function normalizeAnalysis(input, model = 'gpt5') {
            if (!input) return { model, services: [], frames: [], raw: '', errors: ['empty'] };
            let obj = input;
            if (typeof input === 'string') {
                try { obj = JSON.parse(input); }
                catch (e) { return { model, services: [], frames: [], raw: input, errors: ['nonJSON'] }; }
            }
            const services = Array.isArray(obj.services) ? obj.services : [];
            const frames   = Array.isArray(obj.frames)   ? obj.frames   : [];
            const raw      = typeof obj.raw === 'string' ? obj.raw      : (typeof input === 'string' ? input : JSON.stringify(obj));
            const errors   = Array.isArray(obj.errors)   ? obj.errors   : [];
            return { model, services, frames, raw, errors };
        }
        function normalizeServices(list){
            if(!Array.isArray(list)) return [];
            return list.map(s=>{
                const name = s.name || s.service || s.title || 'Service';
                const desc = s.description || s.explanation || s.details || '';
                const cost = Number(s.cost ?? s.price ?? s.ai_suggested_price ?? 0) || 0;
                const priority = s.priority || s.urgency || '';
                return {
                    name,
                    description: desc,
                    cost,
                    priority,
                    original: s
                };
            });
        }
        function svcLen(a){ return (a && Array.isArray(a.services)) ? a.services.length : 0; }
        function svcList(a){ return (a && Array.isArray(a.services)) ? a.services : []; }

        function dashboard() {
            return {
                quotes: [],
                selectedItems: [],
                loading: false,
                gptLoading: false,
                geminiLoading: false,
                isDark: true,
                showRawModal: false,
                rawAiContent: "",
                rawAiImages: [],
                init() {
                    console.log("üå≤ Carpe Tree Admin Dashboard initialized");
                    this.loadTheme();
                    this.loadQuotes();
                },
                loadTheme() {
                    const saved = localStorage.getItem("carpe-tree-theme");
                    this.isDark = saved !== "light";
                    this.applyTheme();
                },
                toggleTheme() {
                    this.isDark = !this.isDark;
                    this.applyTheme();
                    localStorage.setItem("carpe-tree-theme", this.isDark ? "dark" : "light");
                    console.log("Theme toggled to:", this.isDark ? "dark" : "light");
                },
                applyTheme() {
                    if (this.isDark) {
                        document.body.removeAttribute("data-theme");
                    } else {
                        document.body.setAttribute("data-theme", "light");
                    }
                },
                async loadQuotes() {
                    this.loading = true;
                    try {
                        const response = await fetch("/server/api/admin-quotes.php");
                        const data = await response.json();
                        if (data.success) {
                            this.quotes = data.quotes.map(quote => ({
                                ...quote,
                                status: quote.status || quote.quote_status || 'pending',
                                showContext: false,
                                context: quote.context || '',
                                gpt_analysis: (()=>{
                                    const a = normalizeAnalysis(quote.ai_gpt5_analysis || quote.gpt_analysis, 'gpt5');
                                    a.services = normalizeServices(a.services);
                                    return a;
                                })(),
                                gemini_analysis: (()=>{
                                    const a = normalizeAnalysis(quote.ai_gemini_analysis || quote.gemini_analysis, 'gemini');
                                    a.services = normalizeServices(a.services);
                                    return a;
                                })()
                            }));
                            console.log("‚úÖ Quotes loaded:", this.quotes.length, "quotes");
                        } else {
                            console.error("‚ùå Failed to load quotes:", data.error);
                        }
                    } catch (error) {
                        console.error("‚ùå Error loading quotes:", error);
                    } finally {
                        this.loading = false;
                    }
                },
                toggleContext(quoteId) {
                    const quote = this.quotes.find(q => q.id == quoteId);
                    if (quote) quote.showContext = !quote.showContext;
                },
                clearContext(quoteId) {
                    const quote = this.quotes.find(q => q.id == quoteId);
                    if (quote) quote.context = "";
                },
                async saveContext(quoteId) {
                    const quote = this.quotes.find(q => q.id == quoteId);
                    if (!quote) return;
                    try {
                        const res = await fetch('/server/api/save-quote-context.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ quote_id: quoteId, context: quote.context }) });
                        const data = await res.json();
                        alert(data.success ? '‚úÖ Context saved!' : ('‚ùå ' + (data.error || 'Save failed')));
                    } catch (e) { alert('‚ùå Save failed: ' + e.message); }
                },
                async showRawAI(quoteId) {
                    try {
                        const res = await fetch(`/server/api/get-full-ai-output-with-images.php?quote_id=${quoteId}`);
                        const data = await res.json();
                        if (data && data.success) {
                            let content = '';
                            if (data.transcription) {
                                content += 'üé§ TRANSCRIPTION\n' + (Array.isArray(data.transcription) ? JSON.stringify(data.transcription, null, 2) : JSON.stringify(data.transcription, null, 2)) + '\n\n';
                            }
                            if (data.gpt5_analysis) { content += 'ü§ñ GPT‚Äë5\n' + data.gpt5_analysis + '\n\n'; }
                            if (data.gemini_analysis) { content += 'üíé Gemini\n' + data.gemini_analysis + '\n\n'; }
                            this.rawAiContent = content || 'No AI output available.';
                            this.rawAiImages = data.images || [];
                            this.showRawModal = true;
                        } else {
                            alert('‚ùå Failed to load Raw AI: ' + (data && data.error ? data.error : 'Unknown'));
                        }
                    } catch (e) { alert('‚ùå Raw AI error: ' + e.message); }
                },
                async transcribeMedia(quote) {
                    try {
                        const response = await fetch("/server/api/media-transcribe.php", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ quote_id: quote.id })
                        });
                        const data = await response.json();
                        if (data.success) {
                            quote.transcript = data.transcript;
                            alert("‚úÖ Media transcribed successfully!");
                        } else {
                            alert("‚ùå Transcription error: " + data.error);
                        }
                    } catch (error) {
                        alert("‚ùå Transcription error: " + error.message);
                    }
                },
                async runGPT5Analysis(quote) {
                    this.gptLoading = true;
                    try {
                        const response = await fetch("/server/api/openai-gpt5-analysis.php", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ quote_id: quote.id })
                        });
                        const data = await response.json();
                        if (data.success) {
                            alert("‚úÖ GPT-5 analysis completed!");
                            await this.loadQuotes();
                        } else {
                            alert("‚ùå GPT-5 Error: " + data.error);
                        }
                    } catch (error) {
                        alert("‚ùå GPT-5 Error: " + error.message);
                    } finally {
                        this.gptLoading = false;
                    }
                },
                async runGeminiAnalysis(quote) {
                    this.geminiLoading = true;
                    try {
                        const response = await fetch("/server/api/gemini-2-5-pro-analysis.php", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ quote_id: quote.id })
                        });
                        const data = await response.json();
                        if (data.success) {
                            alert("‚úÖ Gemini analysis completed!");
                            await this.loadQuotes();
                        } else {
                            alert("‚ùå Gemini Error: " + data.error);
                        }
                    } catch (error) {
                        alert("‚ùå Gemini Error: " + error.message);
                    } finally {
                        this.geminiLoading = false;
                    }
                },
                async runBothAI(quote) {
                    await Promise.all([this.runGPT5Analysis(quote), this.runGeminiAnalysis(quote)]);
                },
                toggleLineItem(source, quoteId, index, service, checked) {
                    const itemId = `${source}-${quoteId}-${index}`;
                    if (checked) {
                        this.selectedItems.push({
                            id: itemId,
                            quoteId: quoteId,
                            source: source,
                            name: service.name,
                            description: service.description,
                            cost: service.cost,
                            priority: service.priority
                        });
                        console.log("‚úÖ Added line item:", service.name, "$" + service.cost);
                    } else {
                        this.selectedItems = this.selectedItems.filter(item => item.id !== itemId);
                        console.log("‚ùå Removed line item:", service.name);
                    }
                },
                removeLineItem(itemId) {
                    const item = this.selectedItems.find(i => i.id === itemId);
                    this.selectedItems = this.selectedItems.filter(i => i.id !== itemId);
                    const checkbox = document.getElementById(itemId.replace("GPT-5", "gpt-checkbox").replace("Gemini", "gemini-checkbox"));
                    if (checkbox) checkbox.checked = false;
                    console.log("‚ùå Removed line item:", item?.name);
                },
                async createEstimate() {
                    if (this.selectedItems.length === 0) {
                        alert("‚ùå No line items selected. Please check services from GPT-5 or Gemini analysis first.");
                        return;
                    }
                    try {
                        const response = await fetch("/server/api/create-estimate.php", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ line_items: this.selectedItems })
                        });
                        const data = await response.json();
                        if (data.success) {
                            alert(`‚úÖ Estimate created successfully!\n\nTotal: $${data.total}\nItems: ${data.items_count}\n\nOpening estimate in new tab...`);
                            if (data.estimate_url) window.open(data.estimate_url, "_blank");
                            this.selectedItems = []; // Clear selection
                        } else {
                            alert("‚ùå Error creating estimate: " + data.error);
                        }
                    } catch (error) {
                        alert("‚ùå Error creating estimate: " + error.message);
                    }
                }
            }
        }
    </script>
</body>
</html>