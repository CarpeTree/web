<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå≤ Carpe Tree'em - 4-Column Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .quote-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .quote-header {
            background: linear-gradient(135deg, #2c5f2d, #3a7a3e);
            color: white;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 1rem;
            align-items: center;
        }

        .customer-info h3 {
            margin: 0;
            font-size: 1.5rem;
        }

        .customer-details {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }

        .quote-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            text-align: center;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 0.75rem;
            border-radius: 6px;
        }

        .stat-number {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: 300px 1fr 1fr 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
        }

        .selection-column {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 1rem;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .ai-column {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            height: fit-content;
        }

        .ai-gemini { border-left: 4px solid #4285f4; background: linear-gradient(135deg, #f8fbff, #e8f4fd); }
        .ai-openai { border-left: 4px solid #00a67e; background: linear-gradient(135deg, #f0fdf4, #dcfce7); }
        .ai-claude { border-left: 4px solid #cc785c; background: linear-gradient(135deg, #fdf8f6, #fef2f2); }

        .ai-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .cost-badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .analysis-section {
            margin: 1rem 0;
        }

        .analysis-text {
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .line-items {
            margin-top: 1rem;
        }

        .line-item {
            background: white;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            font-size: 0.9rem;
        }

        .line-item-header {
            font-weight: bold;
            color: #2c5f2d;
        }

        .line-item-price {
            color: #666;
            font-size: 0.8rem;
        }

        .selection-group {
            margin: 1rem 0;
            padding: 0.75rem;
            background: rgba(255,255,255,0.8);
            border-radius: 6px;
        }

        .selection-label {
            font-weight: bold;
            color: #856404;
            margin-bottom: 0.5rem;
            display: block;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .checkbox-option:hover {
            background: rgba(255,255,255,0.5);
        }

        .checkbox-option input[type="checkbox"] {
            margin-right: 0.5rem;
            transform: scale(1.2);
        }

        .manual-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .context-textarea {
            width: 100%;
            height: 60px;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 0.5rem 0;
            font-size: 0.9rem;
            resize: vertical;
        }

        .retrigger-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
            margin-top: 0.5rem;
        }

        .retrigger-btn:hover {
            background: #138496;
        }

        .total-summary {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: #155724;
            margin-top: 1rem;
        }

        .media-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .media-item {
            background: white;
            padding: 0.5rem;
            border-radius: 6px;
            text-align: center;
        }

        .media-item img {
            max-width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }

        .action-buttons {
            padding: 1rem;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            background: #007bff;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-info { background: #17a2b8; }
        .btn-info:hover { background: #138496; }

        .loading { 
            text-align: center; 
            padding: 3rem; 
            color: #6b7280; 
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå≤ Carpe Tree'em - 4-Column Analysis Dashboard</h1>
    </div>

    <div class="container" x-data="adminDashboard()" x-init="init()">
        <!-- Loading State -->
        <div x-show="loading" class="loading">
            <div>üîÑ Loading quotes with AI analysis...</div>
        </div>

        <!-- Empty State -->
        <div x-show="!loading && quotes.length === 0" class="empty-state">
            <div>üìù No quotes found with AI analysis data</div>
        </div>

        <!-- Quote Analysis Cards -->
        <template x-for="quote in quotes" :key="quote.id">
            <div class="quote-card">
                <!-- Quote Header -->
                <div class="quote-header">
                    <div class="customer-info">
                        <h3 x-text="`#${quote.id} - ${quote.customer_name}`"></h3>
                        <div class="customer-details">
                            <div x-text="`üìß ${quote.customer_email} | üìû ${quote.phone}`"></div>
                            <div x-text="`üìç ${quote.address} | üõ£Ô∏è ${quote.distance_km}km`"></div>
                        </div>
                    </div>
                    
                    <div class="quote-stats">
                        <div class="stat-item">
                            <div class="stat-number" x-text="quote.files?.length || 0"></div>
                            <div class="stat-label">Media Files</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">3</div>
                            <div class="stat-label">AI Models</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" x-text="`$${quote.final_total || 0}`"></div>
                            <div class="stat-label">Estimate</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" x-text="quote.status"></div>
                            <div class="stat-label">Status</div>
                        </div>
                    </div>
                </div>

                <!-- Media Section -->
                <div class="media-section" x-show="quote.files && quote.files.length > 0">
                    <h4>üì∏ Media Files</h4>
                    <div class="media-grid">
                        <template x-for="file in quote.files" :key="file.id">
                            <div class="media-item">
                                <div x-show="file.mime_type?.includes('image')">
                                    <img :src="`/uploads/${file.filename}`" :alt="file.original_filename" />
                                </div>
                                <div x-show="file.mime_type?.includes('video')">
                                    üìπ Video
                                </div>
                                <div x-text="file.original_filename" style="font-size: 0.8rem; margin-top: 0.5rem;"></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- 4-Column Analysis Grid -->
                <div class="analysis-grid">
                    <!-- Selection Column -->
                    <div class="selection-column">
                        <h3 style="text-align: center; margin-bottom: 1rem; color: #856404;">‚úÖ Your Selection</h3>
                        
                        <!-- Tree Species Selection -->
                        <div class="selection-group">
                            <span class="selection-label">üå≤ Tree Species</span>
                            <div class="checkbox-option">
                                <input type="checkbox" :name="`species_gemini_${quote.id}`" @change="logSelection(quote.id, 'species', 'gemini', $event.target.checked)">
                                <span>Gemini: Oak (85% confidence)</span>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" :name="`species_openai_${quote.id}`" @change="logSelection(quote.id, 'species', 'openai', $event.target.checked)">
                                <span>OpenAI: Maple (92% confidence)</span>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" :name="`species_claude_${quote.id}`" @change="logSelection(quote.id, 'species', 'claude', $event.target.checked)">
                                <span>Claude: Birch (78% confidence)</span>
                            </div>
                            <input type="text" placeholder="Or enter manually..." class="manual-input" @input="logManualInput(quote.id, 'species', $event.target.value)">
                        </div>

                        <!-- Tree Height Selection -->
                        <div class="selection-group">
                            <span class="selection-label">üìè Tree Height</span>
                            <div class="checkbox-option">
                                <input type="checkbox" :name="`height_gemini_${quote.id}`" @change="logSelection(quote.id, 'height', 'gemini', $event.target.checked)">
                                <span>Gemini: 18m</span>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" :name="`height_openai_${quote.id}`" @change="logSelection(quote.id, 'height', 'openai', $event.target.checked)">
                                <span>OpenAI: 20m</span>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" :name="`height_claude_${quote.id}`" @change="logSelection(quote.id, 'height', 'claude', $event.target.checked)">
                                <span>Claude: 17m</span>
                            </div>
                            <input type="text" placeholder="Or enter manually..." class="manual-input" @input="logManualInput(quote.id, 'height', $event.target.value)">
                        </div>

                        <!-- Crown Spread Selection -->
                        <div class="selection-group">
                            <span class="selection-label">üåø Crown Spread</span>
                            <div class="checkbox-option">
                                <input type="checkbox" :name="`crown_gemini_${quote.id}`" @change="logSelection(quote.id, 'crown_spread', 'gemini', $event.target.checked)">
                                <span>Gemini: 12m</span>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" :name="`crown_openai_${quote.id}`" @change="logSelection(quote.id, 'crown_spread', 'openai', $event.target.checked)">
                                <span>OpenAI: 14m</span>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" :name="`crown_claude_${quote.id}`" @change="logSelection(quote.id, 'crown_spread', 'claude', $event.target.checked)">
                                <span>Claude: 11m</span>
                            </div>
                            <input type="text" placeholder="Or enter manually..." class="manual-input" @input="logManualInput(quote.id, 'crown_spread', $event.target.value)">
                        </div>

                        <!-- DBH Selection -->
                        <div class="selection-group">
                            <span class="selection-label">üìê DBH (Diameter at Breast Height)</span>
                            <div class="checkbox-option">
                                <input type="checkbox" :name="`dbh_gemini_${quote.id}`" @change="logSelection(quote.id, 'dbh', 'gemini', $event.target.checked)">
                                <span>Gemini: 45cm</span>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" :name="`dbh_openai_${quote.id}`" @change="logSelection(quote.id, 'dbh', 'openai', $event.target.checked)">
                                <span>OpenAI: 52cm</span>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" :name="`dbh_claude_${quote.id}`" @change="logSelection(quote.id, 'dbh', 'claude', $event.target.checked)">
                                <span>Claude: 48cm</span>
                            </div>
                            <input type="text" placeholder="Or enter manually..." class="manual-input" @input="logManualInput(quote.id, 'dbh', $event.target.value)">
                        </div>
                    </div>

                    <!-- Gemini Analysis -->
                    <div class="ai-column ai-gemini">
                        <div class="ai-header">
                            <h3>üî∑ Google Gemini 2.5 Pro</h3>
                            <span class="cost-badge">$0.15</span>
                        </div>
                        
                        <div class="analysis-section">
                            <h4>üìã Analysis</h4>
                            <div class="analysis-text">
                                Large mature oak tree showing good overall health. Minor deadwood in crown requires removal. Tree is well-positioned and structurally sound. Recommended maintenance pruning to remove deadwood and improve air circulation. No immediate safety concerns identified.
                            </div>
                        </div>

                        <div class="line-items">
                            <h4>üí∞ Line Items</h4>
                            <div class="line-item">
                                <div class="line-item-header">Tree Pruning - Deadwood Removal</div>
                                <div class="line-item-price">$450 - $650 (climbing access required)</div>
                            </div>
                            <div class="line-item">
                                <div class="line-item-header">Crown Thinning</div>
                                <div class="line-item-price">$300 - $500 (improve air circulation)</div>
                            </div>
                            <div class="line-item">
                                <div class="line-item-header">Brush Removal</div>
                                <div class="line-item-price">$150 - $200 (estimated 2m¬≥ of brush)</div>
                            </div>
                        </div>

                        <div class="total-summary">Total: $900 - $1,350</div>

                        <textarea placeholder="Add context for re-analysis..." class="context-textarea"></textarea>
                        <button class="retrigger-btn" @click="retriggerAnalysis(quote.id, 'gemini')">üîÑ Re-analyze with Context</button>
                    </div>

                    <!-- OpenAI Analysis -->
                    <div class="ai-column ai-openai">
                        <div class="ai-header">
                            <h3>üü¢ OpenAI GPT-4</h3>
                            <span class="cost-badge">$0.23</span>
                        </div>
                        
                        <div class="analysis-section">
                            <h4>üìã Analysis</h4>
                            <div class="analysis-text">
                                This appears to be a mature maple tree with significant size and good structural integrity. Some concern about proximity to structures. Tree shows signs of stress in certain areas but overall healthy. Professional assessment recommended for removal vs pruning decision.
                            </div>
                        </div>

                        <div class="line-items">
                            <h4>üí∞ Line Items</h4>
                            <div class="line-item">
                                <div class="line-item-header">Tree Removal (if required)</div>
                                <div class="line-item-price">$1,200 - $1,800 (complex rigging needed)</div>
                            </div>
                            <div class="line-item">
                                <div class="line-item-header">Alternative: Heavy Pruning</div>
                                <div class="line-item-price">$600 - $900 (reduce crown by 30%)</div>
                            </div>
                            <div class="line-item">
                                <div class="line-item-header">Stump Grinding</div>
                                <div class="line-item-price">$350 - $500 (if removal chosen)</div>
                            </div>
                        </div>

                        <div class="total-summary">Range: $600 - $2,300</div>

                        <textarea placeholder="Add context for re-analysis..." class="context-textarea"></textarea>
                        <button class="retrigger-btn" @click="retriggerAnalysis(quote.id, 'openai')">üîÑ Re-analyze with Context</button>
                    </div>

                    <!-- Claude Analysis -->
                    <div class="ai-column ai-claude">
                        <div class="ai-header">
                            <h3>üü† Anthropic Claude</h3>
                            <span class="cost-badge">$0.18</span>
                        </div>
                        
                        <div class="analysis-section">
                            <h4>üìã Analysis</h4>
                            <div class="analysis-text">
                                Birch tree displaying characteristic bark and growth pattern. Tree appears to be in decline phase with some dieback visible in upper crown. Structural assessment needed to determine safety. May benefit from crown reduction or could require removal depending on extent of decay.
                            </div>
                        </div>

                        <div class="line-items">
                            <h4>üí∞ Line Items</h4>
                            <div class="line-item">
                                <div class="line-item-header">Tree Health Assessment</div>
                                <div class="line-item-price">$200 - $300 (professional evaluation)</div>
                            </div>
                            <div class="line-item">
                                <div class="line-item-header">Crown Reduction</div>
                                <div class="line-item-price">$400 - $700 (if tree is salvageable)</div>
                            </div>
                            <div class="line-item">
                                <div class="line-item-header">Complete Removal</div>
                                <div class="line-item-price">$800 - $1,200 (if assessment shows decay)</div>
                            </div>
                        </div>

                        <div class="total-summary">Range: $600 - $1,500</div>

                        <textarea placeholder="Add context for re-analysis..." class="context-textarea"></textarea>
                        <button class="retrigger-btn" @click="retriggerAnalysis(quote.id, 'claude')">üîÑ Re-analyze with Context</button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <a :href="`https://carpetree.com/admin-dashboard.html?quote=${quote.id}`" class="btn btn-success">üéõÔ∏è Full Admin View</a>
                    <a :href="`https://maps.google.com/maps?q=${quote.address}`" class="btn btn-info">üó∫Ô∏è View on Maps</a>
                    <a :href="`mailto:${quote.customer_email}`" class="btn">üìß Email Customer</a>
                    <button class="btn" @click="generateFinalQuote(quote.id)">üìã Generate Final Quote</button>
                </div>
            </div>
        </template>
    </div>

    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        function adminDashboard() {
            return {
                quotes: [],
                loading: true,

                async init() {
                    await this.loadQuotes();
                },

                async loadQuotes() {
                    try {
                        // Try to load quotes with AI analysis data
                        const response = await fetch('./server/api/admin-quotes.php');
                        const data = await response.json();
                        
                        if (data.quotes) {
                            // Filter quotes that have AI analysis or media files
                            this.quotes = data.quotes.filter(quote => 
                                quote.files?.length > 0 || 
                                quote.ai_summary || 
                                quote.ai_gemini_analysis ||
                                quote.ai_o4_mini_analysis
                            );
                        }
                    } catch (error) {
                        console.error('Failed to load quotes:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                logSelection(quoteId, field, aiType, checked) {
                    fetch('/server/api/log-admin-usage.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action: 'ai_selection',
                            quote_id: quoteId,
                            field: field,
                            ai_type: aiType,
                            value: checked,
                            timestamp: new Date().toISOString()
                        })
                    });
                },

                logManualInput(quoteId, field, value) {
                    if (value.trim()) {
                        fetch('/server/api/log-admin-usage.php', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                action: 'manual_input',
                                quote_id: quoteId,
                                field: field,
                                value: value,
                                timestamp: new Date().toISOString()
                            })
                        });
                    }
                },

                retriggerAnalysis(quoteId, aiType) {
                    const textarea = event.target.previousElementSibling;
                    const context = textarea.value;
                    
                    if (!context.trim()) {
                        alert('Please add some context for the re-analysis');
                        return;
                    }
                    
                    fetch('/server/api/log-admin-usage.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action: 'retrigger_analysis',
                            quote_id: quoteId,
                            ai_type: aiType,
                            context: context,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    alert(`Re-triggering ${aiType} analysis with your context...`);
                    window.location.href = `/server/api/regenerate-ai-analysis.php?quote_id=${quoteId}&ai_type=${aiType}&context=${encodeURIComponent(context)}`;
                },

                generateFinalQuote(quoteId) {
                    alert(`Generating final quote for #${quoteId} based on your selections...`);
                    // Implementation would collect all selected checkboxes and manual inputs
                }
            };
        }
    </script>
</body>
</html>