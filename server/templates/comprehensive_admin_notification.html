<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>🌳 New Quote #{quote_id} - Complete Analysis Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.4; color: #333; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #2c5f2d, #3a7a3e); color: white; padding: 20px; text-align: center; }
        .section { padding: 20px; border-bottom: 1px solid #eee; }
        .grid-4 { display: grid; grid-template-columns: 250px 1fr 1fr 1fr; gap: 20px; margin: 20px 0; }
        .ai-column { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #e9ecef; }
        .ai-gemini { border-color: #4285f4; background: #f8fbff; }

        .ai-o3 { border-color: #00a67e; background: #f0fdf4; }
        .ai-o4mini { border-color: #ff6b6b; background: #fff5f5; }
        .selection-column { background: #fff3cd; padding: 15px; border-radius: 8px; border: 2px solid #ffd700; }
        .checkbox-group { margin: 10px 0; }
        .checkbox-group input[type="checkbox"] { margin-right: 8px; transform: scale(1.2); }
        .data-item { margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #28a745; }
        .cost-summary { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0; font-weight: bold; }
        .media-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
        .media-item { background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; }
        .media-item img { max-width: 100%; height: 120px; object-fit: cover; border-radius: 4px; }
        .btn { background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; margin: 4px; }
        .btn-admin { background: #28a745; }
        .btn-maps { background: #4285f4; }
        .line-item { background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 6px; border-left: 4px solid #28a745; }
        .urgency-high { border-left-color: #dc3545; background: #f8d7da; }
        .urgency-medium { border-left-color: #ffc107; background: #fff3cd; }
        .analysis-text { background: white; padding: 12px; border-radius: 6px; border: 1px solid #dee2e6; white-space: pre-line; max-height: 300px; overflow-y: auto; }
        .context-input { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; margin: 8px 0; }
        .retrigger-btn { background: #17a2b8; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Quote Summary -->
        <div class="header">
            <h1>🌳 New Quote #{quote_id} - {customer_name}</h1>
            <p>📧 {customer_email} | 📞 {customer_phone} | 📍 {distance_km}km from base</p>
            <p>🕒 Submitted: {submission_time} | 📋 Services: {services}</p>
        </div>

        <!-- Customer & Location Info -->
        <div class="section">
            <h2>👤 Customer Information</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div>
                    <strong>Contact:</strong><br>
                    📧 {customer_email}<br>
                    📞 {customer_phone}<br>
                    📍 {customer_address}
                </div>
                <div>
                    <strong>Location:</strong><br>
                    🗺️ Distance: {distance_km}km ({travel_time})<br>
                    📊 Travel Cost: ${travel_cost}<br>
                    🎯 GPS: {gps_coordinates}
                </div>
                <div>
                    <strong>Request Details:</strong><br>
                    📝 Notes: {customer_notes}<br>
                    📊 Urgency: {urgency_level}<br>
                    🔄 Status: {quote_status}
                </div>
            </div>
        </div>

        <!-- Key Images Only (Email Optimized) -->
        <div class="section">
            <h2>📸 Key Images (Best 3-4 Photos Only)</h2>
            <div class="media-grid">
                {key_image_items}
            </div>
            <p style="color: #666; font-style: italic; text-align: center; margin-top: 15px;">
                📎 <strong>Full media files</strong> (including videos, audio transcripts, and all photos) available in the <a href="https://carpetree.com/admin-dashboard.html?quote={quote_id}">Admin Dashboard</a>
            </p>
        </div>

        <!-- 4-Column AI Analysis Comparison -->
        <div class="section">
            <h2>🤖 AI Analysis Comparison & Selection</h2>
            <div class="grid-4">
                <!-- Selection Column -->
                <div class="selection-column">
                    <h3>✅ Your Selection</h3>
                    <p><em>Check the boxes for the analysis you want to use:</em></p>
                    
                    <div class="data-item">
                        <strong>🌲 Tree Species:</strong>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="species_gemini"> Gemini: {gemini_species}</label><br>
                            <label><input type="checkbox" name="species_o3"> o3: {o3_species}</label><br>
                            <label><input type="checkbox" name="species_o4mini"> o4-mini: {o4mini_species}</label><br>
                            <input type="text" placeholder="Or enter manually..." class="context-input">
                        </div>
                    </div>

                    <div class="data-item">
                        <strong>📏 Tree Height:</strong>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="height_gemini"> Gemini: {gemini_height}</label><br>
                            <label><input type="checkbox" name="height_o3"> o3: {o3_height}</label><br>
                            <label><input type="checkbox" name="height_o4mini"> o4-mini: {o4mini_height}</label><br>
                            <input type="text" placeholder="Or enter manually..." class="context-input">
                        </div>
                    </div>

                    <div class="data-item">
                        <strong>🌿 Crown Spread:</strong>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="crown_gemini"> Gemini: {gemini_crown}</label><br>
                            <label><input type="checkbox" name="crown_o3"> o3: {o3_crown}</label><br>
                            <label><input type="checkbox" name="crown_o4mini"> o4-mini: {o4mini_crown}</label><br>
                            <input type="text" placeholder="Or enter manually..." class="context-input">
                        </div>
                    </div>

                    <div class="data-item">
                        <strong>📐 DBH (Diameter at Breast Height):</strong>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="dbh_gemini"> Gemini: {gemini_dbh}</label><br>
                            <label><input type="checkbox" name="dbh_o3"> o3: {o3_dbh}</label><br>
                            <label><input type="checkbox" name="dbh_o4mini"> o4-mini: {o4mini_dbh}</label><br>
                            <input type="text" placeholder="Or enter manually..." class="context-input">
                        </div>
                    </div>

                    <div class="data-item">
                        <strong>🗑️ Waste Disposal:</strong>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="waste_gemini"> Gemini: {gemini_waste}</label><br>
                            <label><input type="checkbox" name="waste_o3"> o3: {o3_waste}</label><br>
                            <label><input type="checkbox" name="waste_o4mini"> o4-mini: {o4mini_waste}</label><br>
                            <input type="text" placeholder="Or enter manually..." class="context-input">
                        </div>
                    </div>
                </div>

                <!-- Google Gemini 2.5 Pro -->
                <div class="ai-column ai-gemini">
                    <h3>💎 Google Gemini 2.5 Pro</h3>
                    <div class="cost-summary">💰 Cost: ${gemini_cost}</div>
                    
                    <div class="analysis-text" id="gemini_analysis">
                        <div class="analysis-preview">{ai_gemini_analysis}</div>
                        <button onclick="toggleAnalysis('gemini')">Show More</button>
                    </div>
                    
                    <div class="selection-group">
                        <label class="selection-label">🌲 Tree Species:</label>
                        <div class="checkbox-option">
                            <input type="checkbox" name="species_gemini"> Use Gemini's species identification
                        </div>
                    </div>
                    
                    <div class="selection-group">
                        <label class="selection-label">📏 Height:</label>
                        <div class="checkbox-option">
                            <input type="checkbox" name="height_gemini"> Use Gemini's height estimate
                        </div>
                    </div>
                    
                    <div class="selection-group">
                        <label class="selection-label">🌿 Crown Spread:</label>
                        <div class="checkbox-option">
                            <input type="checkbox" name="crown_gemini"> Use Gemini's crown measurements
                        </div>
                    </div>
                    
                    <div class="selection-group">
                        <label class="selection-label">🗑️ Waste Disposal:</label>
                        <div class="checkbox-option">
                            <input type="checkbox" name="waste_gemini"> Use Gemini's disposal estimate
                        </div>
                    </div>
                    
                    <textarea placeholder="Add context for re-analysis..." class="context-input"></textarea>
                    <button class="retrigger-btn" onclick="retriggerAnalysis('gemini')">🔄 Re-analyze with Context</button>
                </div>

                <!-- OpenAI o3 -->
                <div class="ai-column ai-o3">
                    <h3>🧠 OpenAI o3</h3>
                    <div class="cost-summary">💰 Cost: ${o3_cost}</div>
                    
                    <div class="analysis-text" id="o3_analysis">
                        <div class="analysis-preview">{ai_o3_analysis}</div>
                        <button onclick="toggleAnalysis('o3')">Show More</button>
                    </div>
                    
                    <div class="selection-group">
                        <label class="selection-label">🌲 Tree Species:</label>
                        <div class="checkbox-option">
                            <input type="checkbox" name="species_o3"> Use o3's species identification
                        </div>
                    </div>
                    
                    <div class="selection-group">
                        <label class="selection-label">📏 Height:</label>
                        <div class="checkbox-option">
                            <input type="checkbox" name="height_o3"> Use o3's height estimate
                        </div>
                    </div>
                    
                    <div class="selection-group">
                        <label class="selection-label">🌿 Crown Spread:</label>
                        <div class="checkbox-option">
                            <input type="checkbox" name="crown_o3"> Use o3's crown measurements
                        </div>
                    </div>
                    
                    <div class="selection-group">
                        <label class="selection-label">🗑️ Waste Disposal:</label>
                        <div class="checkbox-option">
                            <input type="checkbox" name="waste_o3"> Use o3's disposal estimate
                        </div>
                    </div>
                    
                    <textarea placeholder="Add context for re-analysis..." class="context-input"></textarea>
                    <button class="retrigger-btn" onclick="retriggerAnalysis('o3')">🔄 Re-analyze with Context</button>
                </div>

                <!-- OpenAI GPT-5 (stored in ai_o4_mini_analysis field for compatibility) -->
                <div class="ai-column ai-o4mini">
                    <h3>🧠 OpenAI GPT-5</h3>
                    <div class="cost-summary">💰 Cost: ${o4_mini_cost}</div>
                    
                    <div class="analysis-text" id="o4mini_analysis">
                        <div class="analysis-preview">{ai_o4_mini_analysis}</div>
                        <button onclick="toggleAnalysis('o4mini')">Show More</button>
                    </div>
                    
                    <div class="selection-group">
                        <label class="selection-label">🌲 Tree Species:</label>
                        <div class="checkbox-option">
                            <input type="checkbox" name="species_o4mini"> Use o4-mini's species identification
                        </div>
                    </div>
                    
                    <div class="selection-group">
                        <label class="selection-label">📏 Height:</label>
                        <div class="checkbox-option">
                            <input type="checkbox" name="height_o4mini"> Use o4-mini's height estimate
                        </div>
                    </div>
                    
                    <div class="selection-group">
                        <label class="selection-label">🌿 Crown Spread:</label>
                        <div class="checkbox-option">
                            <input type="checkbox" name="crown_o4mini"> Use o4-mini's crown measurements
                        </div>
                    </div>
                    
                    <div class="selection-group">
                        <label class="selection-label">🗑️ Waste Disposal:</label>
                        <div class="checkbox-option">
                            <input type="checkbox" name="waste_o4mini"> Use o4-mini's disposal estimate
                        </div>
                    </div>
                    
                    <textarea placeholder="Add context for re-analysis..." class="context-input"></textarea>
                    <button class="retrigger-btn" onclick="retriggerAnalysis('o4mini')">🔄 Re-analyze with Context</button>
                </div>
            </div>
        </div>

        <!-- Itemized Cost Breakdown -->
        <div class="section">
            <h2>💰 Detailed Cost Breakdown</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="line-item">
                    <strong>🌲 Tree Work:</strong><br>
                    • Removal: ${removal_cost}<br>
                    • Pruning: ${pruning_cost}<br>
                    • Climbing: ${climbing_cost}<br>
                    • Rigging: ${rigging_cost}
                </div>
                <div class="line-item">
                    <strong>🗑️ Disposal:</strong><br>
                    • Brush Removal: ${brush_removal_cost}<br>
                    • Wood Processing: ${wood_processing_cost}<br>
                    • Firewood Service: ${firewood_cost}<br>
                    • Transfer Station: ${transfer_station_cost}
                </div>
                <div class="line-item">
                    <strong>🚛 Logistics:</strong><br>
                    • Travel ({distance_km}km): ${travel_cost}<br>
                    • Equipment Transport: ${equipment_cost}<br>
                    • Disposal Transport: ${disposal_transport_cost}
                </div>
            </div>
            
            <div class="cost-summary" style="font-size: 1.2em; text-align: center; margin-top: 20px;">
                🎯 <strong>TOTAL QUOTE RANGE: ${total_min} - ${total_max}</strong>
            </div>
        </div>

        <!-- Waste Disposal Information -->
        <div class="section">
            <h2>🗑️ Waste Disposal Analysis</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div>
                    <strong>Nearest Transfer Station:</strong><br>
                    📍 {nearest_transfer_station}<br>
                    🛣️ Distance: {transfer_station_distance}km<br>
                    💰 Cost: ${transfer_station_rate}/tonne<br>
                    📊 Estimated Weight: {estimated_waste_weight} tonnes
                </div>
                <div>
                    <strong>Brush Volume Estimate:</strong><br>
                    🌿 Volume: {estimated_brush_volume}m³<br>
                    ⚖️ Weight: {estimated_brush_weight} tonnes<br>
                    🚛 Truck Loads: {estimated_truck_loads}<br>
                    💰 Total Disposal: ${total_disposal_cost}
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="section" style="text-align: center;">
            <a href="https://carpetree.com/admin-dashboard.html?quote={quote_id}" class="btn btn-admin">🎛️ Open Full Admin Dashboard</a>
            <a href="https://maps.google.com/maps?q={customer_address}" class="btn btn-maps">🗺️ View Location on Maps</a>
            <a href="https://carpetree.com/customer-crm-dashboard.html?customer_id={customer_id}" class="btn">👤 Customer History</a>
            <a href="mailto:{customer_email}" class="btn">📧 Email Customer</a>
        </div>

        <!-- AI Cost Summary -->
        <div class="section">
            <h2>📊 AI Analysis Cost Summary</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="cost-summary">Gemini 2.5 Pro: ${gemini_cost}</div>
                <div class="cost-summary">OpenAI o3: ${o3_cost}</div>
                <div class="cost-summary">OpenAI o4-mini: ${o4_mini_cost}</div>
                <div class="cost-summary"><strong>Total AI Cost: ${total_ai_cost}</strong></div>
            </div>
        </div>

        <!-- Audio Transcription (Summary Only) -->
        <div class="section" style="{audio_section_display}">
            <h2>🎵 Audio Notes Summary</h2>
            <div class="analysis-text" style="max-height: 100px; overflow-y: auto;">
                {audio_summary}
            </div>
            <p style="color: #666; font-style: italic; text-align: center; margin-top: 10px;">
                📎 <strong>Full audio transcription</strong> available in the <a href="https://carpetree.com/admin-dashboard.html?quote={quote_id}">Admin Dashboard</a>
            </p>
        </div>

        <!-- Footer -->
        <div style="background: #f8f9fa; padding: 20px; text-align: center; color: #666;">
            <p>🌲 <strong>Carpe Tree'em Professional Analysis Dashboard</strong></p>
            <p>Generated: {current_timestamp} | Quote ID: #{quote_id}</p>
        </div>
    </div>

    <script>
        function toggleAnalysis(aiType) {
            const analysisDiv = document.getElementById(`${aiType}_analysis`);
            const preview = analysisDiv.querySelector('.analysis-preview');
            const button = analysisDiv.querySelector('button');
            
            if (preview.style.maxHeight === 'none') {
                preview.style.maxHeight = '150px';
                preview.style.overflow = 'hidden';
                button.textContent = 'Show More';
            } else {
                preview.style.maxHeight = 'none';
                preview.style.overflow = 'visible';
                button.textContent = 'Show Less';
            }
        }

        function retriggerAnalysis(aiType) {
            const textarea = event.target.previousElementSibling;
            const context = textarea.value;
            const quoteId = "{quote_id}";
            
            if (!context.trim()) {
                alert('Please add some context for the re-analysis');
                return;
            }
            
            // Log usage
            fetch('/server/api/log-admin-usage.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'retrigger_analysis',
                    ai_type: aiType,
                    quote_id: quoteId,
                    context: context,
                    timestamp: new Date().toISOString()
                })
            });
            
            // Trigger re-analysis
            alert(`Re-triggering ${aiType} analysis with your context...`);
            window.location.href = `/server/api/regenerate-ai-analysis.php?quote_id=${quoteId}&ai_type=${aiType}&context=${encodeURIComponent(context)}`;
        }
        
        // Log selection changes
        document.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox' || e.target.type === 'text') {
                fetch('/server/api/log-admin-usage.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'selection_change',
                        field: e.target.name || 'manual_input',
                        value: e.target.type === 'checkbox' ? e.target.checked : e.target.value,
                        quote_id: "{quote_id}",
                        timestamp: new Date().toISOString()
                    })
                });
            }
        });
    </script>
</body>
</html>