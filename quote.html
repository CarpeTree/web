<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Get Your Tree Service Quote - Carpe Tree'em</title>
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="stylesheet" href="style.css?v=20250812">
  <link rel="stylesheet" href="https://releases.transloadit.com/uppy/v3.24.0/uppy.min.css">
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    /* Ensure nav overlays contact header on mobile */
    nav { z-index: 1002; }
    .quote-wizard {
      max-width: 800px;
      margin: 120px auto 40px;
      padding: 0 20px;
    }
    
    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 40px;
    }
    
    .step {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .step.active {
      background: var(--deep-forest-green);
      color: var(--background-color);
    }
    
    .step.completed {
      background: var(--muted-golden-amber);
      color: var(--deep-forest-green);
    }
    
    .step.inactive {
      background: #e0e0e0;
      color: #888;
    }
    
    .step-content {
      background: var(--background-color);
      border: 2px solid var(--deep-forest-green);
      border-radius: 8px;
      padding: 40px;
      margin-bottom: 30px;
    }
    
    .step-content h2 {
      color: var(--deep-forest-green);
      margin-bottom: 20px;
      border-bottom: 2px solid var(--deep-forest-green);
      padding-bottom: 10px;
    }
    
    .service-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin: 30px auto;
      max-width: 600px;
    }
    
    .service-option {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      background: white;
      text-align: center;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .service-option:hover {
      border-color: var(--deep-forest-green);
      box-shadow: 0 4px 12px rgba(76, 122, 79, 0.15);
    }
    
    .service-option.selected {
      border-color: var(--deep-forest-green);
      background: var(--deep-forest-green);
      color: var(--background-color);
    }
    
    .service-option input[type="checkbox"] {
      position: absolute;
      top: 12px;
      right: 12px;
      transform: scale(1.2);
    }
    
    .service-option h4 {
      margin: 10px 0 8px 0;
      font-size: 16px;
      font-weight: 600;
    }
    
    .service-option p {
      margin: 0;
      font-size: 14px;
      opacity: 0.85;
      line-height: 1.4;
    }
    
    @media (max-width: 600px) {
      .service-grid {
        grid-template-columns: 1fr;
      }
      
      .service-option {
        min-height: 60px;
        padding: 8px;
      }
      
      .service-option h4 {
        font-size: 14px;
        margin: 5px 0 4px 0;
      }
      
      .service-option p {
        font-size: 12px;
        line-height: 1.3;
      }
      
      /* Mobile-friendly address field layout */
      .form-group .flex {
        flex-direction: column;
        gap: 8px;
      }
      
      .form-group button {
        align-self: flex-start;
        padding: 10px 16px;
        font-size: 14px;
      }
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: var(--deep-forest-green);
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid var(--deep-forest-green);
      border-radius: 4px;
      font-size: 1em;
    }
    
    .btn {
      background: var(--background-color);
      color: var(--deep-forest-green);
      padding: 12px 30px;
      border: 2px solid var(--deep-forest-green);
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      transition: all 0.3s ease;
      margin: 10px;
    }
    
    .btn:hover {
      background: var(--deep-forest-green);
      color: var(--background-color);
    }
    
    .btn-primary {
      background: var(--deep-forest-green);
      color: var(--background-color);
    }
    
    .btn-primary:hover {
      background: var(--muted-golden-amber);
      border-color: var(--muted-golden-amber);
      color: var(--deep-forest-green);
    }
    
    .upload-area {
      border: 3px dashed var(--deep-forest-green);
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      background: rgba(44, 95, 45, 0.05);
    }
    
    .upload-instructions {
      background: rgba(44, 95, 45, 0.1);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }
    
    .location-info {
      background: rgba(44, 95, 45, 0.05);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-size: 0.9em;
    }
    
    .hidden {
      display: none;
    }
    
          /* Mobile menu toggle button */
      .menu-toggle {
        display: none;
        flex-direction: column;
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
      }

      .menu-toggle span {
        width: 25px;
        height: 3px;
        background: var(--deep-forest-green);
        margin: 3px 0;
        transition: 0.3s;
      }

      @media (max-width: 768px) {
        .menu-toggle {
          display: flex;
          position: relative;
          z-index: 1003;
        }
        
        .nav-container {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          position: relative;
        }
        
        .nav-links {
          display: none;
          flex-direction: column;
          width: 100vw;
          background: var(--background-color);
          border: 2px solid var(--deep-forest-green);
          border-radius: 8px;
          padding: 20px 0;
          margin: 0;
          position: fixed;
          top: 80px;
          left: 0;
          right: 0;
          z-index: 1002;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          /* Override global collapsing nav */
          max-height: calc(100vh - 90px) !important;
          overflow-y: auto !important;
        }
        
        .nav-links.active {
          display: flex !important;
          max-height: calc(100vh - 90px) !important;
        }
        
        .nav-links a {
          padding: 18px 20px;
          border: none;
          text-align: center;
          width: 100%;
          border-bottom: 1px solid var(--deep-forest-green);
          font-size: 1.1rem;
          font-weight: 600;
        }
        
        .nav-links a:last-child {
          border-bottom: none;
        }
        
        .nav-links a:hover {
          background: var(--muted-golden-amber);
          color: var(--deep-forest-green);
        }
        
        /* Prevent body scroll when menu is open */
        body.menu-open {
          overflow: hidden !important;
          position: fixed;
          width: 100%;
        }
        
        .quote-wizard {
          margin-top: 150px;
          padding: 0 15px;
        }
        
        .step-content {
          padding: 20px;
        }
        
        .service-grid {
          grid-template-columns: 1fr;
        }
      }
  </style>
</head>
<body>
  <!-- Contact Header -->
  <div class="contact-header">
    <a href="tel:+17786553741">778-655-3741</a> |
    <a href="mailto:sapport@carpetree.com">sapport@carpetree.com</a>
  </div>

  <!-- Navigation -->
  <nav>
    <div class="nav-container">
      <button class="menu-toggle" 
              aria-label="Toggle navigation menu" 
              aria-expanded="false" 
              aria-controls="nav-links"
              type="button">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="nav-links" id="nav-links">
        <a href="index.html">Home</a>
                    <a href="quote.html">Get Quote</a>
        <a href="philosophy.html">Philosophy</a>
        <a href="services.html">Services</a>
        <a href="root-knowledge.html">Root Knowledge</a>
        <a href="lets-talk.html">Let's Talk Trees</a>
      </div>
    </div>
  </nav>

  <div class="quote-wizard" x-data="quoteWizard()">
    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step" :class="getStepClass(1)">1</div>
      <div class="step" :class="getStepClass(2)">2</div>
      <div class="step" :class="getStepClass(3)">3</div>
    </div>

    <!-- Step 1: Upload Media -->
    <div class="step-content" x-show="currentStep === 1" x-transition>
      <h2>Step 1: Share Your Tree Photos & Videos</h2>
      <p>Upload photos, videos, or voice recordings of your trees. Include wide shots and close-ups of any problem areas.</p>
      
      <div class="upload-instructions">
        <h4>üì∏ Photo Tips:</h4>
        <ul>
          <li>Wide shot showing the entire tree and surroundings</li>
          <li>Close-up of trunk base and root flare</li>
          <li>Photos of any damage, dead branches, or concerning areas</li>
          <li>Include nearby structures, power lines, or other trees</li>
        </ul>
      </div>
      
      <div class="upload-area" id="upload-area">
        <p>Drag and drop files here, or click to browse</p>
        <p><small>Supports: Images (JPG, PNG), Videos (MP4, MOV), Audio (MP3, M4A)</small></p>
      </div>
      
      <div class="location-info" x-show="locationCaptured">
        <p><strong>üìç Location captured:</strong> <span x-text="locationText"></span></p>
      </div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-primary" @click="nextStep()" x-bind:disabled="!canProceedStep1()">
          Next: Select Services
        </button>
      </div>
    </div>

    <!-- Step 2: Select Services -->
    <div class="step-content" x-show="currentStep === 2" x-transition>
      <h2>Step 2: What Services Do You Need?</h2>
      <p>Select all services you're interested in. Our AI will analyze your media and provide specific recommendations.</p>
      
      <div class="service-grid">
        <template x-for="service in services" :key="service.id">
          <div class="service-option" 
               :class="{'selected': selectedServices.includes(service.id)}"
               @click="toggleService(service.id)">
            <input type="checkbox" :checked="selectedServices.includes(service.id)" readonly>
            <h4 x-text="service.name"></h4>
            <p x-text="service.description"></p>
          </div>
        </template>
      </div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button class="btn" @click="prevStep()">Back</button>
        <button class="btn btn-primary" @click="nextStep()" x-bind:disabled="selectedServices.length === 0">
          Next: Contact Info
        </button>
      </div>
    </div>

    <!-- Step 3: Contact Information -->
    <div class="step-content" x-show="currentStep === 3" x-transition>
      <h2>Step 3: Contact Information</h2>
                <p>Upload videos and photos of your trees for a detailed quote within 24 hours.</p>
      
      <form @submit.prevent="submitQuote()">
        <div class="form-group">
          <label for="email">Email Address *</label>
          <input type="email" id="email" name="email" x-model="formData.email" 
                 autocomplete="email" required>
        </div>
        
        <div class="form-group">
          <label for="name">Full Name</label>
          <input type="text" id="name" name="name" x-model="formData.name" 
                 autocomplete="name">
        </div>
        
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="tel" id="phone" name="phone" x-model="formData.phone" 
                 autocomplete="tel">
        </div>
        
        <div class="form-group">
          <label for="address">Address</label>
          <div class="flex" style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="address" name="address" x-model="formData.address" rows="3" 
                      placeholder="Street address, city, postal code" 
                      autocomplete="street-address"
                      style="flex: 1;"></textarea>
            <button type="button" @click="useMyLocation()" 
                    style="background: #2D5A27; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; white-space: nowrap; cursor: pointer;"
                    :disabled="locationLoading">
              <span x-show="!locationLoading">üìç Use My Location</span>
              <span x-show="locationLoading">‚è≥ Getting Location...</span>
            </button>
          </div>
          <div x-show="locationText" style="margin-top: 5px; font-size: 12px; color: #666;">
            <div x-text="locationText"></div>
            <div x-show="gpsCoords" style="margin-top: 3px; font-size: 11px; color: #2D5A27; font-weight: 500;">
              üå≥ Precise GPS coordinates saved for tree location identification
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="referral">How did you hear about us?</label>
          <select id="referral" x-model="formData.referralSource">
            <option value="">Select an option</option>
            <option value="google">Google Search</option>
            <option value="facebook">Facebook</option>
            <option value="instagram">Instagram</option>
            <option value="referral">Friend/Family Referral</option>
            <option value="neighbor">Neighbor Recommendation</option>
            <option value="previous_work">Saw Your Previous Work</option>
            <option value="online_review">Online Reviews</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group" x-show="formData.referralSource === 'referral'">
          <label for="referrer">Referrer Name</label>
          <input type="text" id="referrer" x-model="formData.referrerName" placeholder="Who referred you?">
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="newsletter" x-model="formData.newsletterOptIn">
          <label for="newsletter">Subscribe to our tree care newsletter</label>
        </div>
        
        <div class="form-group">
          <label for="notes">Additional Notes</label>
          <textarea id="notes" x-model="formData.notes" rows="4" placeholder="Any specific concerns, questions, or additional context about your trees?"></textarea>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
          <button type="button" class="btn" @click="prevStep()">Back</button>
          <button type="submit" id="submitBtn" class="btn btn-primary" x-bind:disabled="submitting">
            <span x-show="!submitting">Submit Quote Request</span>
            <span x-show="submitting">Submitting...</span>
          </button>
        </div>
        <div id="submitProgress" style="display:none; margin-top:12px;">
          <div style="height:8px;background:#e9ecef;border-radius:4px;overflow:hidden;">
            <div id="submitProgressBar" style="height:8px;width:0%;background:var(--deep-forest-green);transition:width .2s;"></div>
          </div>
          <div id="submitStatus" style="font-size:12px;margin-top:6px;color:#2D5A27;">Preparing upload‚Ä¶</div>
          <div id="submitStatusLink" style="font-size:12px;margin-top:6px;color:#555;display:none;">
            Live status: <a id="progressLink" href="#" target="_blank" style="color:var(--deep-forest-green);text-decoration:underline;">open</a>
          </div>
          <div style="font-size:12px;margin-top:4px;color:#555;">
            Large video uploads can take time. After upload finishes, we personally review all quotes. You‚Äôll receive a response within 3 days.
          </div>
        </div>
      </form>
    </div>

    <!-- Success/Feedback Message -->
    <div class="step-content" x-show="submitted" x-transition>
        <h2 x-text="submissionMessage.startsWith('We need') ? 'Additional Information Required' : 'üå≥ Quote Request Submitted!'"></h2>
        <p x-text="submissionMessage"></p>
        
        <div x-show="moreInfoUrl">
            <p>Please click the button below to add more files to your quote.</p>
            <a :href="moreInfoUrl" class="btn btn-primary">Upload More Files</a>
        </div>
        
        <div x-show="!moreInfoUrl">
            <p><strong>What happens next:</strong></p>
            <ul>
                <li>Professional review of your photos/videos</li>
                <li>Professional review and quote preparation (within 24 hours)</li>
                <li>Detailed quote emailed to you with specific recommendations</li>
            </ul>
        </div>
        <p>Questions? Call us at <a href="tel:7786553741" style="color: var(--deep-forest-green); font-weight: bold;">778-655-3741</a></p>
    </div>
  </div>

  <script src="https://releases.transloadit.com/uppy/v3.24.0/uppy.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  
  <!-- Mobile Menu JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const menuToggle = document.querySelector('.menu-toggle');
      const navLinks = document.querySelector('.nav-links');
      
      console.log('Menu elements found:', { menuToggle: !!menuToggle, navLinks: !!navLinks });
      
      if (menuToggle && navLinks) {
        
        // Toggle menu on hamburger click
        menuToggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Menu toggle clicked');
          
          const isActive = navLinks.classList.contains('active');
          
          if (isActive) {
            closeMenu();
          } else {
            openMenu();
          }
        });
        
        // Touch event for mobile
        menuToggle.addEventListener('touchstart', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Menu toggle touched');
          
          const isActive = navLinks.classList.contains('active');
          
          if (isActive) {
            closeMenu();
          } else {
            openMenu();
          }
        });
        
        // Close menu when a link is clicked
        const navItems = document.querySelectorAll('.nav-links a');
        navItems.forEach(item => {
          item.addEventListener('click', function() {
            closeMenu();
          });
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
          if (navLinks.classList.contains('active') && 
              !navLinks.contains(e.target) && 
              !menuToggle.contains(e.target)) {
            closeMenu();
          }
        });
        
        // Close menu on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && navLinks.classList.contains('active')) {
            closeMenu();
          }
        });
        
        function openMenu() {
          console.log('Opening menu');
          navLinks.classList.add('active');
          menuToggle.classList.add('active');
          document.body.classList.add('menu-open');
          menuToggle.setAttribute('aria-expanded', 'true');
        }
        
        function closeMenu() {
          console.log('Closing menu');
          navLinks.classList.remove('active');
          menuToggle.classList.remove('active');
          document.body.classList.remove('menu-open');
          menuToggle.setAttribute('aria-expanded', 'false');
        }
        
      } else {
        console.error('Menu elements not found:', { menuToggle, navLinks });
      }
    });
  </script>
  
  <script>
    function quoteWizard() {
      return {
        currentStep: 1,
        submitting: false,
        submitted: false,
        submissionMessage: '',
        moreInfoUrl: '',
        uploadedFiles: [],
        locationLoading: false,
        locationCaptured: false,
        locationText: '',
        gpsCoords: null,
        exifCoords: null,
        exifByFileId: {},
        selectedServices: [],
        formData: {
          email: '',
          name: '',
          phone: '',
          address: '',
          referralSource: '',
          referrerName: '',
          newsletterOptIn: false,
          notes: '',
          otherServiceDetails: '' // Added for "not sure" service
        },
        services: [
          {
            id: 'sprinklers',
            name: 'Sprinkler Systems',
            description: 'Wildfire protection sprinkler installation and maintenance'
          },
          {
            id: 'fuel_modification',
            name: 'Fuel Modification',
            description: 'FireSmart vegetation management and defensible space creation'
          },
          {
            id: 'removal',
            name: 'Tree Removal',
            description: 'Safe removal of dead, diseased, or hazardous trees'
          },
          {
            id: 'pruning',
            name: 'Tree Pruning',
            description: 'Professional pruning for health, safety, and aesthetics'
          },

          {
            id: 'planting',
            name: 'Tree Planting',
            description: 'Species selection and professional planting'
          },
          {
            id: 'assessment',
            name: 'Tree Health Assessment',
            description: 'Professional evaluation of tree condition and risks'
          },
          {
            id: 'cabling',
            name: 'Tree Cabling/Bracing',
            description: 'Structural support for weak or split trees'
          },
          {
            id: 'emergency',
            name: 'Emergency Service',
            description: 'üö® Immediate callback required - Storm damage cleanup and urgent tree removal'
          },
          {
            id: 'not_sure',
            name: 'Not Sure (please elaborate)',
            description: 'Let us help you determine the best services for your needs'
          }
        ],

        init() {
          this.initUploader();
          this.captureLocation();
        },

        initUploader() {
          const uppy = new Uppy.Uppy({
            restrictions: {
              maxFileSize: 1024 * 1024 * 1024, // 1GB
              allowedFileTypes: ['image/*', 'video/*', 'audio/*']
            },
            autoProceed: false
          });

          uppy.use(Uppy.Dashboard, {
            target: '#upload-area',
            inline: true,
            height: 300,
            showProgressDetails: true,
            hideUploadButton: true,
            hideRetryButton: false,
            hidePauseResumeButton: false,
            hideCancelButton: false
          });

          // Optional: wire to chunk endpoint if needed later
          // uppy.use(Uppy.XHRUpload, { endpoint: '/server/api/upload-chunk.php', fieldName: 'file' });

          uppy.on('file-added', (file) => {
            this.uploadedFiles.push(file);
            this.extractExifLocation(file);
          });

          uppy.on('file-removed', (file) => {
            this.uploadedFiles = this.uploadedFiles.filter(f => f.id !== file.id);
          });

          this.uppy = uppy;
        },

        async captureLocation() {
          if ('geolocation' in navigator) {
            try {
              const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 300000
                });
              });
              
              this.gpsCoords = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
              };
              
              this.locationCaptured = true;
              this.locationText = `üìç GPS: ${this.gpsCoords.lat.toFixed(6)}, ${this.gpsCoords.lng.toFixed(6)} (¬±${Math.round(this.gpsCoords.accuracy)}m)`;
            } catch (error) {
              console.log('Geolocation not available or denied');
            }
          }
        },

        async useMyLocation() {
          this.locationLoading = true;
          
          if ('geolocation' in navigator) {
            try {
              const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 300000
                });
              });
              
              this.gpsCoords = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
              };
              
              // Try to reverse geocode the coordinates to get an address
              try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${this.gpsCoords.lat}&lon=${this.gpsCoords.lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data.display_name) {
                  this.formData.address = data.display_name;
                  this.locationText = `üìç Address: ${data.display_name} | GPS: ${this.gpsCoords.lat.toFixed(6)}, ${this.gpsCoords.lng.toFixed(6)} (¬±${Math.round(this.gpsCoords.accuracy)}m)`;
                } else {
                  this.locationText = `üìç GPS: ${this.gpsCoords.lat.toFixed(6)}, ${this.gpsCoords.lng.toFixed(6)} (¬±${Math.round(this.gpsCoords.accuracy)}m)`;
                }
              } catch (geocodeError) {
                // If reverse geocoding fails, just show coordinates
                this.locationText = `üìç GPS: ${this.gpsCoords.lat.toFixed(6)}, ${this.gpsCoords.lng.toFixed(6)} (¬±${Math.round(this.gpsCoords.accuracy)}m) | Address lookup failed`;
                console.log('Reverse geocoding failed:', geocodeError);
              }
              
              this.locationCaptured = true;
            } catch (error) {
              console.log('Geolocation error:', error);
              this.locationText = '‚ùå Location access denied or unavailable';
            }
          } else {
            this.locationText = '‚ùå Geolocation not supported by your browser';
          }
          
          this.locationLoading = false;
        },

        async extractExifLocation(file) {
          try {
            if (!file || !file.data || !file.type || !/^image\//.test(file.type)) return;
            const blob = file.data;
            await new Promise((resolve) => {
              EXIF.getData(blob, () => {
                try {
                  const all = EXIF.getAllTags(blob) || {};
                  // Convert GPS to decimal degrees if present
                  const toDec = (ref, arr) => {
                    if (!Array.isArray(arr) || arr.length < 3) return null;
                    const [d, m, s] = arr.map(v => {
                      if (typeof v === 'object' && v.numerator !== undefined) {
                        return v.numerator / (v.denominator || 1);
                      }
                      return Number(v);
                    });
                    let dec = d + (m / 60) + (s / 3600);
                    if (ref === 'S' || ref === 'W') dec = -dec;
                    return dec;
                  };
                  let exifLat = null;
                  let exifLng = null;
                  if (all.GPSLatitude && all.GPSLatitudeRef) {
                    exifLat = toDec(all.GPSLatitudeRef, all.GPSLatitude);
                  }
                  if (all.GPSLongitude && all.GPSLongitudeRef) {
                    exifLng = toDec(all.GPSLongitudeRef, all.GPSLongitude);
                  }
                  const plain = {};
                  Object.keys(all).forEach(k => {
                    const v = all[k];
                    try {
                      // best-effort toJSON
                      if (typeof v === 'object' && v !== null) {
                        if ('numerator' in v && 'denominator' in v) {
                          plain[k] = v.numerator / (v.denominator || 1);
                        } else if (Array.isArray(v)) {
                          plain[k] = v.map(x => (x && x.numerator !== undefined) ? (x.numerator / (x.denominator || 1)) : x);
                        } else {
                          plain[k] = String(v);
                        }
                      } else {
                        plain[k] = v;
                      }
                    } catch(e) {
                      plain[k] = String(v);
                    }
                  });
                  if (exifLat !== null && exifLng !== null) {
                    this.exifCoords = { lat: exifLat, lng: exifLng };
                    this.locationCaptured = true;
                    this.locationText = `üì∑ EXIF GPS: ${exifLat.toFixed(6)}, ${exifLng.toFixed(6)}`;
                  }
                  this.exifByFileId[file.id] = { exif: plain, exifLat, exifLng };
                } catch (err) {
                  console.warn('EXIF parse error for', file.name, err);
                }
                resolve();
              });
            });
          } catch (err) {
            console.warn('EXIF extraction failed for', file && file.name, err);
          }
        },

        getStepClass(stepNumber) {
          if (stepNumber < this.currentStep) return 'completed';
          if (stepNumber === this.currentStep) return 'active';
          return 'inactive';
        },

        canProceedStep1() {
          // Allow proceeding with or without files
          return true; // Files are now optional
        },

        toggleService(serviceId) {
          if (this.selectedServices.includes(serviceId)) {
            this.selectedServices = this.selectedServices.filter(id => id !== serviceId);
          } else {
            this.selectedServices.push(serviceId);
            
            // Special handling for emergency service
            if (serviceId === 'emergency') {
              alert('üö® EMERGENCY SERVICE SELECTED\n\nFor immediate assistance, please call us directly at:\n778-655-3741\n\nWe will also prioritize your quote request for urgent review.');
            }
            
            // Special handling for "not sure" service
            if (serviceId === 'not_sure') {
              const otherDetails = prompt('Please tell us more about what you need:\n\n‚Ä¢ What type of tree work are you considering?\n‚Ä¢ Are there specific problems you\'re seeing?\n‚Ä¢ What\'s your timeline?\n\nWe\'ll help determine the best services for your situation.');
              if (otherDetails) {
                // Store the details in formData for submission
                this.formData.otherServiceDetails = otherDetails;
              } else {
                // If user cancels, remove the service
                this.selectedServices = this.selectedServices.filter(id => id !== serviceId);
              }
            }
          }
        },

        nextStep() {
          if (this.currentStep < 3) {
            this.currentStep++;
          }
        },

        prevStep() {
          if (this.currentStep > 1) {
            this.currentStep--;
          }
        },

        async submitQuote() {
          this.submitting = true;
          
          try {
            // Show grounded progress UI
            const progressEl = document.getElementById('submitProgress');
            const progressBar = document.getElementById('submitProgressBar');
            const statusEl = document.getElementById('submitStatus');
            if (progressEl && progressBar && statusEl) {
              progressEl.style.display = 'block';
              progressBar.style.width = '5%';
              statusEl.textContent = 'Preparing upload‚Ä¶';
            }
            const form = document.querySelector('form');
            const formData = new FormData(form);
            
            // Enhanced location capture
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log("Got geolocation:", position.coords);
                        
                        // Add hidden fields for geolocation data
                        const geoData = document.createElement('div');
                        geoData.innerHTML = `
                            <input type="hidden" name="geo_latitude" value="${position.coords.latitude}">
                            <input type="hidden" name="geo_longitude" value="${position.coords.longitude}">
                            <input type="hidden" name="geo_accuracy" value="${position.coords.accuracy}">
                        `;
                        form.appendChild(geoData);
                        
                        console.log("Added geolocation data to form submission");
                    },
                    function(error) {
                        console.log("Geolocation error:", error.message);
                        // Continue without geolocation - not critical
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000  // 5 minutes
                    }
                );
            } else {
                console.log("Geolocation not supported by browser");
            }
            
            // Add form data
            Object.keys(this.formData).forEach(key => {
              formData.append(key, this.formData[key]);
            });
            
            // Add selected services
            formData.append('selectedServices', JSON.stringify(this.selectedServices));
            
            // Add other service details if provided
            if (this.formData.otherServiceDetails) {
              formData.append('otherServiceDetails', this.formData.otherServiceDetails);
            }
            
            // Add location data
            if (this.gpsCoords) {
              formData.append('gpsLat', this.gpsCoords.lat);
              formData.append('gpsLng', this.gpsCoords.lng);
              formData.append('gpsAccuracy', this.gpsCoords.accuracy);
              console.log('Including precise GPS coordinates for tree location:', this.gpsCoords);
            }
            
            if (this.exifCoords) {
              formData.append('exifLat', this.exifCoords.lat);
              formData.append('exifLng', this.exifCoords.lng);
            }
            
            // Add uploaded files
            // Upload with progress using XHR
            const xhr = new XMLHttpRequest();
            const endpoint = '/server/api/submitQuote-working.php';
            xhr.open('POST', endpoint, true);
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.timeout = 900000; // 15 minutes
            // attach a client-side progress id so we can poll server
            const progressId = 'p_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8);
            formData.append('progress_id', progressId);
            const statusLinkEl = document.getElementById('submitStatusLink');
            const progressLink = document.getElementById('progressLink');
            if (statusLinkEl && progressLink) {
              const url = '/server/api/progress.php?id=' + encodeURIComponent(progressId);
              progressLink.href = url;
              statusLinkEl.style.display = 'block';
            }
            xhr.upload.onprogress = (e) => {
              if (e.lengthComputable && progressBar && statusEl) {
                const pct = Math.min(90, Math.round((e.loaded / e.total) * 90));
                progressBar.style.width = pct + '%';
                statusEl.textContent = 'Uploading media‚Ä¶ ' + pct + '%';
              }
            };
            xhr.upload.onload = () => {
              if (progressBar) progressBar.style.width = '95%';
              if (statusEl) statusEl.textContent = 'Submitting request‚Ä¶';
            };
            this.uploadedFiles.forEach((file, index) => {
              formData.append(`files[${index}]`, file.data);
              const exif = this.exifByFileId[file.id];
              if (exif) {
                try { formData.append(`exif[${index}]`, JSON.stringify(exif)); } catch (e) {}
              }
            });
            
            // Wrap XHR in a promise to reuse existing logic
            const responseText = await new Promise((resolve, reject) => {
              xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                  resolve(xhr.responseText);
                }
              };
              xhr.onerror = () => reject(new Error('Network error'));
              xhr.send(formData);
              if (statusEl) statusEl.textContent = 'Submitting request‚Ä¶';
              if (progressBar) progressBar.style.width = '95%';
              // While waiting for server, slowly advance to 99%
              let visual = 95;
              const tick = setInterval(() => {
                if (xhr.readyState === 4 || visual >= 99) { clearInterval(tick); return; }
                visual += 0.5; if (progressBar) progressBar.style.width = visual + '%';
                if (statusEl) statusEl.textContent = 'Finalizing‚Ä¶ ' + Math.floor(visual) + '%';
              }, 800);
            });
            let result;
            try {
              result = JSON.parse(responseText);
            } catch (parseError) {
              console.error('JSON parse error:', parseError);
              throw new Error('Invalid response from server: ' + String(responseText).substring(0, 120));
            }
            if (!result || result.success !== true) {
              throw new Error((result && result.error) || 'Submission failed');
            }

          if (result && result.success) {
              console.log('Quote submitted successfully:', result);
              if (progressBar) progressBar.style.width = '100%';
              if (statusEl) statusEl.textContent = 'Upload complete. Starting AI analysis‚Ä¶';

              if (result.preflight_check && !result.preflight_check.sufficient) {
                  // Pre-flight check failed, ask for more info
                  this.submissionMessage = `We need a bit more information to provide an accurate quote: ${result.preflight_check.missing_items.join(', ')}.`;
                  this.moreInfoUrl = `upload-more.html?quote_id=${result.quote_id}`;
              } else {
                  // Pre-flight check passed or not applicable
                  this.submissionMessage = 'Thank you! We\'ve received your tree photos and information. We will review everything and get back to you as soon as possible. May take a couple of days if we\'re out of service, which happens regularly.';
              }
              
              this.submitted = true;
              this.currentStep = 4; // Show success/feedback screen
            } else {
              const errorMsg = result.error || 'Submission failed';
              console.error('Quote submission error:', errorMsg);
              throw new Error(errorMsg);
            }
          } catch (error) {
            console.error('Quote submission failed:', error);
            console.error('Error details:', {
              message: error.message,
              stack: error.stack,
              response: response
            });
            alert('Error submitting quote: ' + error.message + '. Please try again or call us at 778-655-3741');
          }
          
          this.submitting = false;
        }
      }
    }
  </script>
</body>
</html> 