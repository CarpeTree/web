<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Get Your Tree Service Quote - Carpe Tree'em</title>
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://releases.transloadit.com/uppy/v3.24.0/uppy.min.css">
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    .quote-wizard {
      max-width: 800px;
      margin: 120px auto 40px;
      padding: 0 20px;
    }
    
    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 40px;
    }
    
    .step {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .step.active {
      background: var(--deep-forest-green);
      color: var(--background-color);
    }
    
    .step.completed {
      background: var(--muted-golden-amber);
      color: var(--deep-forest-green);
    }
    
    .step.inactive {
      background: #e0e0e0;
      color: #888;
    }
    
    .step-content {
      background: var(--background-color);
      border: 2px solid var(--deep-forest-green);
      border-radius: 8px;
      padding: 40px;
      margin-bottom: 30px;
    }
    
    .step-content h2 {
      color: var(--deep-forest-green);
      margin-bottom: 20px;
      border-bottom: 2px solid var(--deep-forest-green);
      padding-bottom: 10px;
    }
    
    .service-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin: 30px auto;
      max-width: 600px;
    }
    
    .service-option {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      background: white;
      text-align: center;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .service-option:hover {
      border-color: var(--deep-forest-green);
      box-shadow: 0 4px 12px rgba(76, 122, 79, 0.15);
    }
    
    .service-option.selected {
      border-color: var(--deep-forest-green);
      background: var(--deep-forest-green);
      color: var(--background-color);
    }
    
    .service-option input[type="checkbox"] {
      position: absolute;
      top: 12px;
      right: 12px;
      transform: scale(1.2);
    }
    
    .service-option h4 {
      margin: 10px 0 8px 0;
      font-size: 16px;
      font-weight: 600;
    }
    
    .service-option p {
      margin: 0;
      font-size: 14px;
      opacity: 0.85;
      line-height: 1.4;
    }
    
    @media (max-width: 600px) {
      .service-grid {
        grid-template-columns: 1fr;
      }
      
      .service-option {
        min-height: 60px;
        padding: 8px;
      }
      
      .service-option h4 {
        font-size: 14px;
        margin: 5px 0 4px 0;
      }
      
      .service-option p {
        font-size: 12px;
        line-height: 1.3;
      }
      
      /* Mobile-friendly address field layout */
      .form-group .flex {
        flex-direction: column;
        gap: 8px;
      }
      
      .form-group button {
        align-self: flex-start;
        padding: 10px 16px;
        font-size: 14px;
      }
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: var(--deep-forest-green);
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid var(--deep-forest-green);
      border-radius: 4px;
      font-size: 1em;
    }
    
    .btn {
      background: var(--background-color);
      color: var(--deep-forest-green);
      padding: 12px 30px;
      border: 2px solid var(--deep-forest-green);
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      transition: all 0.3s ease;
      margin: 10px;
    }
    
    .btn:hover {
      background: var(--deep-forest-green);
      color: var(--background-color);
    }
    
    .btn-primary {
      background: var(--deep-forest-green);
      color: var(--background-color);
    }
    
    .btn-primary:hover {
      background: var(--muted-golden-amber);
      border-color: var(--muted-golden-amber);
      color: var(--deep-forest-green);
    }

    .btn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    /* Progress Bar Styles */
    .progress-container {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      position: relative;
    }

    .progress-step {
      flex: 1;
      text-align: center;
      position: relative;
      padding: 10px;
    }

    .progress-step::before {
      content: '';
      position: absolute;
      top: 25px;
      left: 50%;
      right: -50%;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }

    .progress-step:last-child::before {
      display: none;
    }

    .progress-step.active::before {
      background: var(--deep-forest-green);
    }

    .step-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      background: #e9ecef;
      color: #6c757d;
      font-size: 20px;
      position: relative;
      z-index: 2;
      transition: all 0.3s ease;
    }

    .progress-step.active .step-icon {
      background: var(--deep-forest-green);
      color: white;
    }

    .progress-step.completed .step-icon {
      background: #28a745;
      color: white;
    }

    .step-label {
      font-size: 14px;
      font-weight: 500;
      color: #6c757d;
    }

    .progress-step.active .step-label {
      color: var(--deep-forest-green);
      font-weight: bold;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--deep-forest-green), #4a7c59);
      transition: width 0.5s ease;
      width: 0%;
    }

    .progress-text {
      text-align: center;
      color: var(--deep-forest-green);
      font-weight: 500;
      margin-top: 10px;
    }
    
    .upload-area {
      border: 3px dashed var(--deep-forest-green);
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      background: rgba(44, 95, 45, 0.05);
    }
    
    .upload-instructions {
      background: rgba(44, 95, 45, 0.1);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }
    
    .location-info {
      background: rgba(44, 95, 45, 0.05);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-size: 0.9em;
    }
    
    .hidden {
      display: none;
    }
    
          /* Mobile menu toggle button */
      .menu-toggle {
        display: none;
        flex-direction: column;
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
      }

      .menu-toggle span {
        width: 25px;
        height: 3px;
        background: var(--deep-forest-green);
        margin: 3px 0;
        transition: 0.3s;
      }

      @media (max-width: 768px) {
        .menu-toggle {
          display: flex;
          position: relative;
          z-index: 1001;
        }
        
        .nav-container {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          position: relative;
        }
        
        .nav-links {
          display: none;
          flex-direction: column;
          width: 100vw;
          background: var(--background-color);
          border: 2px solid var(--deep-forest-green);
          border-radius: 8px;
          padding: 20px 0;
          margin: 0;
          position: fixed;
          top: 80px;
          left: 0;
          right: 0;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .nav-links.active {
          display: flex;
        }
        
        .nav-links a {
          padding: 18px 20px;
          border: none;
          text-align: center;
          width: 100%;
          border-bottom: 1px solid var(--deep-forest-green);
          font-size: 1.1rem;
          font-weight: 600;
        }
        
        .nav-links a:last-child {
          border-bottom: none;
        }
        
        .nav-links a:hover {
          background: var(--muted-golden-amber);
          color: var(--deep-forest-green);
        }
        
        /* Prevent body scroll when menu is open */
        body.menu-open {
          overflow: hidden;
        }
        
        .quote-wizard {
          margin-top: 150px;
          padding: 0 15px;
        }
        
        .step-content {
          padding: 20px;
        }
        
        .service-grid {
          grid-template-columns: 1fr;
        }
      }
  </style>
</head>
<body>
  <!-- Contact Header -->
  <div class="contact-header">
    <a href="tel:7786553741">778-655-3741</a> |
    <a href="mailto:sapport@carpetree.com">sapport@carpetree.com</a>
  </div>

  <!-- Navigation -->
  <nav>
    <div class="nav-container">
      <button class="menu-toggle" 
              aria-label="Toggle navigation menu" 
              aria-expanded="false" 
              aria-controls="nav-links"
              type="button">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="nav-links" id="nav-links">
        <a href="index.html">Home</a>
                    <a href="quote.html">Get Quote</a>
        <a href="philosophy.html">Philosophy</a>
        <a href="services.html">Services</a>
        <a href="root-knowledge.html">Root Knowledge</a>
        <a href="lets-talk.html">Let's Talk Trees</a>
      </div>
    </div>
  </nav>

  <div class="quote-wizard" x-data="quoteWizard()">
    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step" :class="getStepClass(1)">1</div>
      <div class="step" :class="getStepClass(2)">2</div>
      <div class="step" :class="getStepClass(3)">3</div>
    </div>

    <!-- Step 1: Upload Media -->
    <div class="step-content" x-show="currentStep === 1" x-transition>
      <h2>Step 1: Share Your Tree Photos & Videos</h2>
      <p>Upload photos, videos, or voice recordings of your trees. Include wide shots and close-ups of any problem areas.</p>
      
      <div class="upload-instructions">
        <h4>📸 Photo Tips:</h4>
        <ul>
          <li>Wide shot showing the entire tree and surroundings</li>
          <li>Close-up of trunk base and root flare</li>
          <li>Photos of any damage, dead branches, or concerning areas</li>
          <li>Include nearby structures, power lines, or other trees</li>
        </ul>
      </div>
      
      <div class="upload-area" id="upload-area">
        <p>Drag and drop files here, or click to browse</p>
        <p><small>Supports: Images (JPG, PNG), Videos (MP4, MOV), Audio (MP3, M4A)</small></p>
      </div>
      
      <div class="location-info" x-show="locationCaptured">
        <p><strong>📍 Location captured:</strong> <span x-text="locationText"></span></p>
      </div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-primary" @click="nextStep()" x-bind:disabled="!canProceedStep1()">
          Next: Select Services
        </button>
      </div>
    </div>

    <!-- Step 2: Select Services -->
    <div class="step-content" x-show="currentStep === 2" x-transition>
      <h2>Step 2: What Services Do You Need?</h2>
      <p>Select all services you're interested in. Our AI will analyze your media and provide specific recommendations.</p>
      
      <div class="service-grid">
        <template x-for="service in services" :key="service.id">
          <div class="service-option" 
               :class="{'selected': selectedServices.includes(service.id)}"
               @click="toggleService(service.id)">
            <input type="checkbox" :checked="selectedServices.includes(service.id)" readonly>
            <h4 x-text="service.name"></h4>
            <p x-text="service.description"></p>
          </div>
        </template>
      </div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button class="btn" @click="prevStep()">Back</button>
        <button class="btn btn-primary" @click="nextStep()" x-bind:disabled="selectedServices.length === 0">
          Next: Contact Info
        </button>
      </div>
    </div>

    <!-- Step 3: Contact Information -->
    <div class="step-content" x-show="currentStep === 3" x-transition>
      <h2>Step 3: Contact Information</h2>
                <p>Upload videos and photos of your trees for a detailed quote within 24 hours.</p>
      
      <form @submit.prevent="submitQuote()">
        <div class="form-group">
          <label for="email">Email Address *</label>
          <input type="email" id="email" name="email" x-model="formData.email" 
                 autocomplete="email" required>
        </div>
        
        <div class="form-group">
          <label for="name">Full Name</label>
          <input type="text" id="name" name="name" x-model="formData.name" 
                 autocomplete="name">
        </div>
        
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="tel" id="phone" name="phone" x-model="formData.phone" 
                 autocomplete="tel">
        </div>
        
        <div class="form-group">
          <label for="address">Address</label>
          <div class="flex" style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="address" name="address" x-model="formData.address" rows="3" 
                      placeholder="Street address, city, postal code" 
                      autocomplete="street-address"
                      style="flex: 1;"></textarea>
            <button type="button" @click="useMyLocation()" 
                    style="background: #2D5A27; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; white-space: nowrap; cursor: pointer;"
                    :disabled="locationLoading">
              <span x-show="!locationLoading">📍 Use My Location</span>
              <span x-show="locationLoading">⏳ Getting Location...</span>
            </button>
          </div>
          <div x-show="locationText" style="margin-top: 5px; font-size: 12px; color: #666;">
            <div x-text="locationText"></div>
            <div x-show="gpsCoords" style="margin-top: 3px; font-size: 11px; color: #2D5A27; font-weight: 500;">
              🌳 Precise GPS coordinates saved for tree location identification
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="referral">How did you hear about us?</label>
          <select id="referral" x-model="formData.referralSource">
            <option value="">Select an option</option>
            <option value="google">Google Search</option>
            <option value="facebook">Facebook</option>
            <option value="instagram">Instagram</option>
            <option value="referral">Friend/Family Referral</option>
            <option value="neighbor">Neighbor Recommendation</option>
            <option value="previous_work">Saw Your Previous Work</option>
            <option value="online_review">Online Reviews</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group" x-show="formData.referralSource === 'referral'">
          <label for="referrer">Referrer Name</label>
          <input type="text" id="referrer" x-model="formData.referrerName" placeholder="Who referred you?">
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="newsletter" x-model="formData.newsletterOptIn">
          <label for="newsletter">Subscribe to our tree care newsletter</label>
        </div>
        
        <div class="form-group">
          <label for="notes">Additional Notes</label>
          <textarea id="notes" x-model="formData.notes" rows="4" placeholder="Any specific concerns, questions, or additional context about your trees?"></textarea>
        </div>
        
        <!-- Progress Bar -->
        <div id="progressContainer" class="progress-container" x-show="showProgress">
          <div class="progress-steps">
            <div class="progress-step" :class="progressStep >= 1 ? 'active' : ''" id="step-upload">
              <div class="step-icon">📤</div>
              <div class="step-label">Uploading</div>
            </div>
            <div class="progress-step" :class="progressStep >= 2 ? 'active' : ''" id="step-processing">
              <div class="step-icon">⚙️</div>
              <div class="step-label">Processing</div>
            </div>
            <div class="progress-step" :class="progressStep >= 3 ? 'active' : ''" id="step-analysis">
              <div class="step-icon">🤖</div>
              <div class="step-label">AI Analysis</div>
            </div>
            <div class="progress-step" :class="progressStep >= 4 ? 'active' : ''" id="step-complete">
              <div class="step-icon">✅</div>
              <div class="step-label">Complete</div>
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" :style="`width: ${progressPercent}%`"></div>
          </div>
          <div class="progress-text" x-text="progressMessage"></div>
          
          <!-- Processing Time Notice -->
          <div x-show="progressStep >= 2" style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0;">
            <strong>⏳ Processing Notice:</strong> AI analysis may take 2-4 hours to complete. 
            You'll receive an email notification when your detailed report is ready.
          </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
          <button type="button" class="btn" @click="prevStep()">Back</button>
          <button type="submit" class="btn btn-primary" x-bind:disabled="submitting">
            <span x-show="!submitting">Submit Quote Request</span>
            <span x-show="submitting">Processing...</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Success/Feedback Message -->
    <div class="step-content" x-show="submitted" x-transition>
        <h2 x-text="submissionMessage.startsWith('We need') ? 'Additional Information Required' : '🌳 Quote Request Submitted!'"></h2>
        <p x-text="submissionMessage"></p>
        
        <div x-show="moreInfoUrl">
            <p>Please click the button below to add more files to your quote.</p>
            <a :href="moreInfoUrl" class="btn btn-primary">Upload More Files</a>
        </div>
        
        <div x-show="!moreInfoUrl">
            <p><strong>What happens next:</strong></p>
            <ul>
                <li>AI analysis of your photos/videos (immediate)</li>
                <li>Professional review and quote preparation (within 24 hours)</li>
                <li>Detailed quote emailed to you with specific recommendations</li>
            </ul>
        </div>
        <p>Questions? Call us at <a href="tel:7786553741" style="color: var(--deep-forest-green); font-weight: bold;">778-655-3741</a></p>
    </div>
  </div>

  <script src="https://releases.transloadit.com/uppy/v3.24.0/uppy.min.js"></script>
  
  <!-- Mobile Menu JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const menuToggle = document.querySelector('.menu-toggle');
      const navLinks = document.querySelector('.nav-links');
      
      console.log('Menu elements found:', { menuToggle: !!menuToggle, navLinks: !!navLinks });
      
      if (menuToggle && navLinks) {
        
        // Toggle menu on hamburger click
        menuToggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Menu toggle clicked');
          
          const isActive = navLinks.classList.contains('active');
          
          if (isActive) {
            closeMenu();
          } else {
            openMenu();
          }
        });
        
        // Touch event for mobile
        menuToggle.addEventListener('touchstart', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Menu toggle touched');
          
          const isActive = navLinks.classList.contains('active');
          
          if (isActive) {
            closeMenu();
          } else {
            openMenu();
          }
        });
        
        // Close menu when a link is clicked
        const navItems = document.querySelectorAll('.nav-links a');
        navItems.forEach(item => {
          item.addEventListener('click', function() {
            closeMenu();
          });
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
          if (navLinks.classList.contains('active') && 
              !navLinks.contains(e.target) && 
              !menuToggle.contains(e.target)) {
            closeMenu();
          }
        });
        
        // Close menu on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && navLinks.classList.contains('active')) {
            closeMenu();
          }
        });
        
        function openMenu() {
          console.log('Opening menu');
          navLinks.classList.add('active');
          menuToggle.classList.add('active');
          document.body.classList.add('menu-open');
          menuToggle.setAttribute('aria-expanded', 'true');
        }
        
        function closeMenu() {
          console.log('Closing menu');
          navLinks.classList.remove('active');
          menuToggle.classList.remove('active');
          document.body.classList.remove('menu-open');
          menuToggle.setAttribute('aria-expanded', 'false');
        }
        
      } else {
        console.error('Menu elements not found:', { menuToggle, navLinks });
      }
    });
  </script>
  
  <script>
    function quoteWizard() {
      return {
        currentStep: 1,
        submitting: false,
        submitted: false,
        submissionMessage: '',
        moreInfoUrl: '',
        showProgress: false,
        progressStep: 0,
        progressPercent: 0,
        progressMessage: 'Preparing submission...',
        uploadedFiles: [],
        locationLoading: false,
        locationCaptured: false,
        locationText: '',
        gpsCoords: null,
        exifCoords: null,
        selectedServices: [],
        formData: {
          email: '',
          name: '',
          phone: '',
          address: '',
          referralSource: '',
          referrerName: '',
          newsletterOptIn: false,
          notes: '',
          otherServiceDetails: '' // Added for "not sure" service
        },
        services: [
          {
            id: 'sprinklers',
            name: 'Sprinkler Systems',
            description: 'Wildfire protection sprinkler installation and maintenance'
          },
          {
            id: 'fuel_modification',
            name: 'Fuel Modification',
            description: 'FireSmart vegetation management and defensible space creation'
          },
          {
            id: 'removal',
            name: 'Tree Removal',
            description: 'Safe removal of dead, diseased, or hazardous trees'
          },
          {
            id: 'pruning',
            name: 'Tree Pruning',
            description: 'Professional pruning for health, safety, and aesthetics'
          },

          {
            id: 'planting',
            name: 'Tree Planting',
            description: 'Species selection and professional planting'
          },
          {
            id: 'assessment',
            name: 'Tree Health Assessment',
            description: 'Professional evaluation of tree condition and risks'
          },
          {
            id: 'cabling',
            name: 'Tree Cabling/Bracing',
            description: 'Structural support for weak or split trees'
          },
          {
            id: 'emergency',
            name: 'Emergency Service',
            description: '🚨 Immediate callback required - Storm damage cleanup and urgent tree removal'
          },
          {
            id: 'not_sure',
            name: 'Not Sure (please elaborate)',
            description: 'Let us help you determine the best services for your needs'
          }
        ],

        init() {
          this.initUploader();
          this.captureLocation();
        },

        initUploader() {
          const uppy = new Uppy.Uppy({
            restrictions: {
              maxFileSize: 1024 * 1024 * 1024, // 1GB
              allowedFileTypes: ['image/*', 'video/*', 'audio/*']
            }
          });

          uppy.use(Uppy.Dashboard, {
            target: '#upload-area',
            inline: true,
            height: 300,
            showProgressDetails: true,
            hideUploadButton: true,
            hideRetryButton: false,
            hidePauseResumeButton: false,
            hideCancelButton: false
          });

          uppy.on('file-added', async (file) => {
            this.uploadedFiles.push(file);
            
            // Extract EXIF data for enhanced context
            try {
              const exifData = await this.extractEXIFData(file.data);
              if (exifData) {
                file.exifData = exifData;
                console.log('EXIF data extracted for:', file.name, exifData);
                
                // Add GPS coordinates to context if available
                if (exifData.gps) {
                  this.exifCoords = {
                    lat: exifData.gps.latitude,
                    lng: exifData.gps.longitude
                  };
                  console.log('GPS coordinates extracted from EXIF:', this.exifCoords);
                }
              }
            } catch (err) {
              console.warn('EXIF extraction failed for:', file.name, err);
            }
          });

          uppy.on('file-removed', (file) => {
            this.uploadedFiles = this.uploadedFiles.filter(f => f.id !== file.id);
          });

          this.uppy = uppy;
        },

        async captureLocation() {
          if ('geolocation' in navigator) {
            try {
              const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 300000
                });
              });
              
              this.gpsCoords = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
              };
              
              this.locationCaptured = true;
              this.locationText = `📍 GPS: ${this.gpsCoords.lat.toFixed(6)}, ${this.gpsCoords.lng.toFixed(6)} (±${Math.round(this.gpsCoords.accuracy)}m)`;
            } catch (error) {
              console.log('Geolocation not available or denied');
            }
          }
        },

        async useMyLocation() {
          this.locationLoading = true;
          
          if ('geolocation' in navigator) {
            try {
              const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 300000
                });
              });
              
              this.gpsCoords = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
              };
              
              // Try to reverse geocode the coordinates to get an address
              try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${this.gpsCoords.lat}&lon=${this.gpsCoords.lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data.display_name) {
                  this.formData.address = data.display_name;
                  this.locationText = `📍 Address: ${data.display_name} | GPS: ${this.gpsCoords.lat.toFixed(6)}, ${this.gpsCoords.lng.toFixed(6)} (±${Math.round(this.gpsCoords.accuracy)}m)`;
                } else {
                  this.locationText = `📍 GPS: ${this.gpsCoords.lat.toFixed(6)}, ${this.gpsCoords.lng.toFixed(6)} (±${Math.round(this.gpsCoords.accuracy)}m)`;
                }
              } catch (geocodeError) {
                // If reverse geocoding fails, just show coordinates
                this.locationText = `📍 GPS: ${this.gpsCoords.lat.toFixed(6)}, ${this.gpsCoords.lng.toFixed(6)} (±${Math.round(this.gpsCoords.accuracy)}m) | Address lookup failed`;
                console.log('Reverse geocoding failed:', geocodeError);
              }
              
              this.locationCaptured = true;
            } catch (error) {
              console.log('Geolocation error:', error);
              this.locationText = '❌ Location access denied or unavailable';
            }
          } else {
            this.locationText = '❌ Geolocation not supported by your browser';
          }
          
          this.locationLoading = false;
        },

        async extractExifLocation(file) {
          // This is a simplified version - in production you'd use a library like exif-js
                      // Extract EXIF data for enhanced context
            this.extractEXIFData(file).then(exifData => {
              if (exifData) {
                file.exifData = exifData;
                console.log('EXIF data extracted for:', file.name, exifData);
              }
            }).catch(err => {
              console.warn('EXIF extraction failed for:', file.name, err);
            });
        },

        getStepClass(stepNumber) {
          if (stepNumber < this.currentStep) return 'completed';
          if (stepNumber === this.currentStep) return 'active';
          return 'inactive';
        },

        canProceedStep1() {
          // Allow proceeding with or without files
          return true; // Files are now optional
        },

        toggleService(serviceId) {
          if (this.selectedServices.includes(serviceId)) {
            this.selectedServices = this.selectedServices.filter(id => id !== serviceId);
          } else {
            this.selectedServices.push(serviceId);
            
            // Special handling for emergency service
            if (serviceId === 'emergency') {
              alert('🚨 EMERGENCY SERVICE SELECTED\n\nFor immediate assistance, please call us directly at:\n778-655-3741\n\nWe will also prioritize your quote request for urgent review.');
            }
            
            // Special handling for "not sure" service
            if (serviceId === 'not_sure') {
              const otherDetails = prompt('Please tell us more about what you need:\n\n• What type of tree work are you considering?\n• Are there specific problems you\'re seeing?\n• What\'s your timeline?\n\nWe\'ll help determine the best services for your situation.');
              if (otherDetails) {
                // Store the details in formData for submission
                this.formData.otherServiceDetails = otherDetails;
              } else {
                // If user cancels, remove the service
                this.selectedServices = this.selectedServices.filter(id => id !== serviceId);
              }
            }
          }
        },

        nextStep() {
          if (this.currentStep < 3) {
            this.currentStep++;
          }
        },

        prevStep() {
          if (this.currentStep > 1) {
            this.currentStep--;
          }
        },

        // EXIF Data Extraction
        async extractEXIFData(file) {
          return new Promise((resolve, reject) => {
            if (!file.type.startsWith('image/')) {
              resolve(null);
              return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const arrayBuffer = e.target.result;
                const dataView = new DataView(arrayBuffer);
                const exifData = this.parseEXIF(dataView);
                resolve(exifData);
              } catch (error) {
                reject(error);
              }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
          });
        },

        parseEXIF(dataView) {
          // Check for EXIF marker
          if (dataView.getUint16(0) !== 0xFFD8) {
            return null; // Not a JPEG
          }

          let offset = 2;
          let marker;
          
          // Find EXIF marker
          while (offset < dataView.byteLength) {
            marker = dataView.getUint16(offset);
            if (marker === 0xFFE1) {
              break;
            }
            offset += 2 + dataView.getUint16(offset + 2);
          }

          if (marker !== 0xFFE1) {
            return null; // No EXIF data
          }

          // Check for EXIF identifier
          offset += 4;
          if (dataView.getUint32(offset) !== 0x45786966) {
            return null; // Not EXIF
          }

          const exifData = {};
          
          try {
            offset += 6; // Skip EXIF header
            const tiffOffset = offset;
            const byteOrder = dataView.getUint16(offset);
            const littleEndian = byteOrder === 0x4949;
            
            // Extract basic EXIF data
            const ifdOffset = this.getUint32(dataView, offset + 4, littleEndian) + tiffOffset;
            const tags = this.getUint16(dataView, ifdOffset, littleEndian);
            
            for (let i = 0; i < tags; i++) {
              const tagOffset = ifdOffset + 2 + (i * 12);
              const tag = this.getUint16(dataView, tagOffset, littleEndian);
              const type = this.getUint16(dataView, tagOffset + 2, littleEndian);
              const count = this.getUint32(dataView, tagOffset + 4, littleEndian);
              const valueOffset = tagOffset + 8;
              
              // Extract specific tags we care about
              switch (tag) {
                case 0x010F: // Camera make
                  exifData.make = this.getStringValue(dataView, valueOffset, count, littleEndian, tiffOffset);
                  break;
                case 0x0110: // Camera model
                  exifData.model = this.getStringValue(dataView, valueOffset, count, littleEndian, tiffOffset);
                  break;
                case 0x0132: // DateTime
                  exifData.dateTime = this.getStringValue(dataView, valueOffset, count, littleEndian, tiffOffset);
                  break;
                case 0x8769: // EXIF sub-IFD
                  const exifSubData = this.parseExifSubIFD(dataView, valueOffset, littleEndian, tiffOffset);
                  Object.assign(exifData, exifSubData);
                  break;
                case 0x8825: // GPS IFD
                  const gpsData = this.parseGPSIFD(dataView, valueOffset, littleEndian, tiffOffset);
                  if (gpsData) {
                    exifData.gps = gpsData;
                  }
                  break;
              }
            }
            
            return Object.keys(exifData).length > 0 ? exifData : null;
          } catch (error) {
            console.warn('EXIF parsing error:', error);
            return null;
          }
        },

        parseGPSIFD(dataView, valueOffset, littleEndian, tiffOffset) {
          try {
            const gpsOffset = this.getUint32(dataView, valueOffset, littleEndian) + tiffOffset;
            const gpsTags = this.getUint16(dataView, gpsOffset, littleEndian);
            const gps = {};
            
            for (let i = 0; i < gpsTags; i++) {
              const tagOffset = gpsOffset + 2 + (i * 12);
              const tag = this.getUint16(dataView, tagOffset, littleEndian);
              const type = this.getUint16(dataView, tagOffset + 2, littleEndian);
              const count = this.getUint32(dataView, tagOffset + 4, littleEndian);
              const valueOffset = tagOffset + 8;
              
              switch (tag) {
                case 1: // GPS Latitude Ref
                  gps.latRef = String.fromCharCode(this.getUint8(dataView, valueOffset));
                  break;
                case 2: // GPS Latitude
                  gps.lat = this.getRationalArray(dataView, valueOffset, count, littleEndian, tiffOffset);
                  break;
                case 3: // GPS Longitude Ref
                  gps.lngRef = String.fromCharCode(this.getUint8(dataView, valueOffset));
                  break;
                case 4: // GPS Longitude
                  gps.lng = this.getRationalArray(dataView, valueOffset, count, littleEndian, tiffOffset);
                  break;
              }
            }
            
            // Convert to decimal degrees
            if (gps.lat && gps.lng) {
              const latitude = this.dmsToDecimal(gps.lat, gps.latRef);
              const longitude = this.dmsToDecimal(gps.lng, gps.lngRef);
              
              return {
                latitude: latitude,
                longitude: longitude,
                latRef: gps.latRef,
                lngRef: gps.lngRef
              };
            }
            
            return null;
          } catch (error) {
            console.warn('GPS parsing error:', error);
            return null;
          }
        },

        parseExifSubIFD(dataView, valueOffset, littleEndian, tiffOffset) {
          const exifData = {};
          try {
            const exifOffset = this.getUint32(dataView, valueOffset, littleEndian) + tiffOffset;
            const exifTags = this.getUint16(dataView, exifOffset, littleEndian);
            
            for (let i = 0; i < exifTags; i++) {
              const tagOffset = exifOffset + 2 + (i * 12);
              const tag = this.getUint16(dataView, tagOffset, littleEndian);
              const valueOffset = tagOffset + 8;
              
              switch (tag) {
                case 0x9003: // DateTimeOriginal
                  exifData.dateTimeOriginal = this.getStringValue(dataView, valueOffset, 20, littleEndian, tiffOffset);
                  break;
                case 0x829A: // Exposure Time
                  const exposure = this.getRational(dataView, valueOffset, littleEndian, tiffOffset);
                  exifData.exposureTime = exposure;
                  break;
                case 0x829D: // F Number
                  const fNumber = this.getRational(dataView, valueOffset, littleEndian, tiffOffset);
                  exifData.fNumber = fNumber;
                  break;
              }
            }
          } catch (error) {
            console.warn('EXIF sub-IFD parsing error:', error);
          }
          return exifData;
        },

        dmsToDecimal(dmsArray, ref) {
          if (!dmsArray || dmsArray.length < 3) return null;
          
          const degrees = dmsArray[0];
          const minutes = dmsArray[1];
          const seconds = dmsArray[2];
          
          let decimal = degrees + (minutes / 60) + (seconds / 3600);
          
          if (ref === 'S' || ref === 'W') {
            decimal = -decimal;
          }
          
          return Math.round(decimal * 1000000) / 1000000; // 6 decimal places
        },

        getRationalArray(dataView, offset, count, littleEndian, tiffOffset) {
          const values = [];
          const actualOffset = count > 1 ? this.getUint32(dataView, offset, littleEndian) + tiffOffset : offset;
          
          for (let i = 0; i < count; i++) {
            const num = this.getUint32(dataView, actualOffset + (i * 8), littleEndian);
            const den = this.getUint32(dataView, actualOffset + (i * 8) + 4, littleEndian);
            values.push(den !== 0 ? num / den : 0);
          }
          
          return values;
        },

        getRational(dataView, offset, littleEndian, tiffOffset) {
          const actualOffset = this.getUint32(dataView, offset, littleEndian) + tiffOffset;
          const num = this.getUint32(dataView, actualOffset, littleEndian);
          const den = this.getUint32(dataView, actualOffset + 4, littleEndian);
          return den !== 0 ? num / den : 0;
        },

        getStringValue(dataView, offset, count, littleEndian, tiffOffset) {
          const actualOffset = count > 4 ? this.getUint32(dataView, offset, littleEndian) + tiffOffset : offset;
          let str = '';
          
          for (let i = 0; i < count - 1; i++) { // -1 to exclude null terminator
            const char = dataView.getUint8(actualOffset + i);
            if (char === 0) break;
            str += String.fromCharCode(char);
          }
          
          return str;
        },

        getUint32(dataView, offset, littleEndian) {
          return dataView.getUint32(offset, littleEndian);
        },

        getUint16(dataView, offset, littleEndian) {
          return dataView.getUint16(offset, littleEndian);
        },

        getUint8(dataView, offset) {
          return dataView.getUint8(offset);
        },

        async submitQuote() {
          this.submitting = true;
          this.showProgress = true;
          this.progressStep = 1;
          this.progressPercent = 25;
          this.progressMessage = 'Uploading files...';
          
          try {
            const form = document.querySelector('form');
            const formData = new FormData(form);
            
            // Enhanced location capture
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log("Got geolocation:", position.coords);
                        
                        // Add hidden fields for geolocation data
                        const geoData = document.createElement('div');
                        geoData.innerHTML = `
                            <input type="hidden" name="geo_latitude" value="${position.coords.latitude}">
                            <input type="hidden" name="geo_longitude" value="${position.coords.longitude}">
                            <input type="hidden" name="geo_accuracy" value="${position.coords.accuracy}">
                        `;
                        form.appendChild(geoData);
                        
                        console.log("Added geolocation data to form submission");
                    },
                    function(error) {
                        console.log("Geolocation error:", error.message);
                        // Continue without geolocation - not critical
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000  // 5 minutes
                    }
                );
            } else {
                console.log("Geolocation not supported by browser");
            }
            
            // Add form data
            Object.keys(this.formData).forEach(key => {
              formData.append(key, this.formData[key]);
            });
            
            // Add selected services
            formData.append('selectedServices', JSON.stringify(this.selectedServices));
            
            // Add other service details if provided
            if (this.formData.otherServiceDetails) {
              formData.append('otherServiceDetails', this.formData.otherServiceDetails);
            }
            
            // Add location data
            if (this.gpsCoords) {
              formData.append('gpsLat', this.gpsCoords.lat);
              formData.append('gpsLng', this.gpsCoords.lng);
              formData.append('gpsAccuracy', this.gpsCoords.accuracy);
              console.log('Including precise GPS coordinates for tree location:', this.gpsCoords);
            }
            
            if (this.exifCoords) {
              formData.append('exifLat', this.exifCoords.lat);
              formData.append('exifLng', this.exifCoords.lng);
            }
            
            // Add uploaded files with EXIF data
            this.uploadedFiles.forEach((file, index) => {
              formData.append(`files[${index}]`, file.data);
              
              // Add EXIF data if available
              if (file.data.exifData) {
                formData.append(`exif_${index}`, JSON.stringify(file.data.exifData));
                
                // Add GPS coordinates if available
                if (file.data.exifData.gps) {
                  formData.append(`gps_lat_${index}`, file.data.exifData.gps.latitude);
                  formData.append(`gps_lng_${index}`, file.data.exifData.gps.longitude);
                  console.log('Including GPS from EXIF for file', index, file.data.exifData.gps);
                }
              }
            });
            
            // Update progress
            this.progressStep = 2;
            this.progressPercent = 50;
            this.progressMessage = 'Processing media files...';
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // Brief delay for UX
            
            // Try multiple endpoints for maximum reliability
            let response;
            const endpoints = [
              '/server/api/submitQuote-reliable.php',
              '/server/api/submitQuote-working.php',
              '/server/api/submitQuote-no-files.php'
            ];
            
            let lastError;
            for (const endpoint of endpoints) {
              try {
                response = await fetch(endpoint, {
                  method: 'POST',
                  body: formData
                });
                
                if (response.ok) {
                  break; // Success, use this response
                } else {
                  lastError = new Error(`Server error ${response.status} from ${endpoint}`);
                }
              } catch (fetchError) {
                lastError = fetchError;
                continue; // Try next endpoint
              }
            }
            
            if (!response || !response.ok) {
              throw lastError || new Error('All submission endpoints failed');
            }
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            const responseText = await response.text();
            console.log('Raw response:', responseText);
          
          let result;
          try {
            result = JSON.parse(responseText);
          } catch (parseError) {
            console.error('JSON parse error:', parseError);
            throw new Error('Invalid response from server: ' + responseText.substring(0, 100));
          }
          
          if (response.ok && result.success) {
              console.log('Quote submitted successfully:', result);

              // Update progress - AI Analysis
              this.progressStep = 3;
              this.progressPercent = 75;
              this.progressMessage = 'Starting AI analysis...';
              
              await new Promise(resolve => setTimeout(resolve, 1500));
              
              // Complete progress
              this.progressStep = 4;
              this.progressPercent = 100;
              this.progressMessage = 'Analysis queued successfully! 🎉';
              
              await new Promise(resolve => setTimeout(resolve, 1000));

              if (result.preflight_check && !result.preflight_check.sufficient) {
                  // Pre-flight check failed, ask for more info
                  this.submissionMessage = `We need a bit more information to provide an accurate quote: ${result.preflight_check.missing_items.join(', ')}.`;
                  this.moreInfoUrl = `upload-more.html?quote_id=${result.quote_id}`;
              } else {
                  // Pre-flight check passed or not applicable
                  this.submissionMessage = 'Thank you! Your quote request has been submitted successfully. Our AI is analyzing your photos and you'll receive a detailed assessment within 24 hours. Please allow 2-4 hours for comprehensive analysis.';
              }
              
              this.showProgress = false;
              this.submitted = true;
              this.currentStep = 4; // Show success/feedback screen
            } else {
              const errorMsg = result.error || 'Submission failed';
              console.error('Quote submission error:', errorMsg);
              throw new Error(errorMsg);
            }
          } catch (error) {
            console.error('Quote submission failed:', error);
            console.error('Error details:', {
              message: error.message,
              stack: error.stack,
              response: response
            });
            this.showProgress = false;
            alert('Error submitting quote: ' + error.message + '. Please try again or contact us directly at sapport@carpetree.com or 778-655-3741');
          }
          
          this.submitting = false;
        }
      }
    }
  </script>
</body>
</html> 